<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•è€å¯†ç¢¼ v3.0.5 - è§£å¯†åœ–é¨°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5e6c8; /* [å¯ä¿®æ”¹] èƒŒæ™¯åº•è‰² */
            /* èƒŒæ™¯ç´‹ç† */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e6c677' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* 3D å¡ç‰‡ç¿»è½‰æ•ˆæœ */
        .pyramid-card { perspective: 1000px; width: 100%; height: 100%; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }
        
        /* éª°å­å‹•ç•« */
        .dice { transition: transform 0.5s ease-out; }
        .dice.rolling { animation: diceRoll 0.5s ease-in-out; }
        @keyframes diceRoll { 0%{transform:rotateX(0) rotateY(0) rotateZ(0)} 50%{transform:rotateX(720deg) rotateY(360deg) rotateZ(180deg)} 100%{transform:rotateX(0) rotateY(0) rotateZ(0)} }
        
        /* ç©å®¶ç•¶å‰ç‹€æ…‹èˆ‡å¡ç‰‡ç©ºä½ */
        .card-placeholder { border: 2px dashed #d4a85a; border-radius: 0.5rem; background-color: rgba(255,255,255,0.2); }
        .player-card { transition: all 0.3s ease; }
        .player-card:hover { transform: translateY(-3px); }
        .current-player { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5); border-color: #d97706; }
        
        /* äº’å‹•ç‹€æ…‹æ¨£å¼ */
        .selected-for-action { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.7); border: 2px solid #16a34a; transform: scale(1.02); }
        .selected-card-ring { box-shadow: 0 0 0 4px #ef4444; transform: scale(1.05); z-index: 10; }
        
        /* å€’æ•¸è¨ˆæ™‚ç·Šæ€¥ç‹€æ…‹å‹•ç•« (æ¼‚æµ® + æ”¾å¤§) */
        @keyframes urgentFloat { 0%, 100% { transform: translateY(0) scale(1.2); } 50% { transform: translateY(-5px) scale(1.3); } }
        .timer-urgent { animation: urgentFloat 1s ease-in-out infinite; color: #dc2626 !important; text-shadow: 2px 2px 0px #fff; }

        .edit-name-icon { cursor: pointer; user-select: none; margin-left: 8px; display: inline-block; opacity: 0.5; transition: opacity 0.2s; }
        .edit-name-icon:hover { opacity: 1; }
        
        .clickable-dice { cursor: pointer; transition: background-color 0.2s; }
        .clickable-dice:hover { background-color: #fceecb; transform: scale(1.05); }
        
        /* è¨Šæ¯çª—å¼·èª¿æ¨£å¼ */
        .message-highlight { color: #b45309; font-weight: 800; }
        
        /* Modal èƒŒæ™¯æ¨¡ç³Š */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 50; }
        
        /* v3.0 æ–°å¢æ¨£å¼ */
        .role-card { transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .role-card:hover { transform: translateY(-5px); border-color: #d97706; background-color: #fffbeb; }
        
        /* å¹³æ¿å„ªåŒ–ä½ˆå±€ */
        .tablet-layout { display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 1024px) {
            .tablet-layout { flex-direction: row; align-items: flex-start; }
            .tablet-left { width: 45%; flex-shrink: 0; }
            .tablet-right { width: 55%; flex-grow: 1; }
        }

        /* è¼¸å…¥æ¸¸æ¨™æ¨¡æ“¬ */
        .cursor-control-btn { touch-action: manipulation; }
        .cursor-control-btn:active { background-color: #d97706; transform: scale(0.95); }

        /* éš±è—åŸç”Ÿéµç›¤ä½†ä¿ç•™æ¸¸æ¨™ (é€é readonly é…åˆ JS) */
        .formula-input-readonly { caret-color: #d97706; cursor: text; }
        
        /* ç™»å…¥éå ´ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* å­¸ç”Ÿçµ„åˆ¥æŒ‰éˆ• */
        .team-btn { transition: all 0.2s; }
        .team-btn.selected { ring: 4px; ring-color: #d97706; transform: scale(1.05); background-color: #fffbeb; }

        /* v3.0.5 æ–°å¢ï¼šæŒ‰éˆ•é–å®šç‹€æ…‹ */
        .btn-disabled { background-color: #9ca3af !important; background-image: none !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; opacity: 0.7; }
        
        /* v3.0.5 æ–°å¢ï¼šåŠ å¤§é‡‘å­—å¡”æ•¸å­—èˆ‡é‚Šæ¡† */
        .pyramid-num-lg { font-size: 2.5rem; line-height: 1; } 
        @media (min-width: 768px) { .pyramid-num-lg { font-size: 3.5rem; } }
    </style>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen pb-12 text-slate-800">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-6 relative">
            <h1 class="text-3xl md:text-5xl font-black text-amber-800 mb-2 drop-shadow-sm tracking-wide">ğŸº æ³•è€å¯†ç¢¼ v3.0.5</h1>
            <p class="text-lg text-amber-700 font-medium">é€£ç·šç‰ˆ - å¤åŸƒåŠæ•¸å­¸è©¦ç…‰</p>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-mono text-gray-400">é€£ç·šä¸­...</div>
        </div>
        
        <div id="page-role-select" class="max-w-4xl mx-auto fade-in">
            <h2 class="text-2xl font-bold text-center mb-8 text-amber-900">è«‹é¸æ“‡ä½ çš„èº«ä»½</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="role-card bg-white rounded-3xl p-8 shadow-xl text-center" onclick="app.selectRole('teacher')">
                    <div class="text-6xl mb-4">ğŸ‘‘</div>
                    <h3 class="text-2xl font-bold text-amber-800 mb-2">æˆ‘æ˜¯æ³•è€ç‹ (è€å¸«)</h3>
                    <p class="text-slate-600">ä¸»æŒè©¦ç…‰ã€æŒæ§å‘½é‹éª°å­ã€æŸ¥çœ‹ç¥æ®¿å¤§å»³ã€‚</p>
                </div>
                <div class="role-card bg-white rounded-3xl p-8 shadow-xl text-center" onclick="app.selectRole('student')">
                    <div class="text-6xl mb-4">ğŸ¤ </div>
                    <h3 class="text-2xl font-bold text-amber-800 mb-2">æˆ‘æ˜¯å†’éšªè€… (å­¸ç”Ÿ)</h3>
                    <p class="text-slate-600">åŠ å…¥æ¢éšªéšŠã€ç ´è§£å¤è€åœ–é¨°ã€çˆ­å¥ªå¯¶è—ã€‚</p>
                </div>
            </div>
        </div>

        <div id="page-teacher-setup" class="hidden max-w-md mx-auto bg-amber-50 rounded-2xl p-8 shadow-xl border-4 border-amber-700 fade-in">
            <h2 class="text-2xl font-bold text-center mb-6 text-amber-900">ğŸ‘‘ æ³•è€ç‹ç™»åŸºå„€å¼</h2>
            <div class="mb-6">
                <label class="block text-amber-800 font-bold mb-2">è¨­å®šç­ç´šä»£ç¢¼ (Class ID)</label>
                <input type="text" id="setup-class-id" class="w-full p-4 border-2 border-amber-300 rounded-xl text-center text-2xl font-bold uppercase" placeholder="ä¾‹å¦‚: 501" maxlength="6">
            </div>
            <button onclick="app.createClass()" class="w-full bg-amber-800 hover:bg-amber-900 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-xl">å»ºç«‹æˆ¿é–“</button>
            <button onclick="app.backToRole()" class="mt-4 w-full text-amber-700 font-bold py-2">â¬…ï¸ è¿”å›</button>
        </div>

        <div id="page-student-login" class="hidden max-w-2xl mx-auto bg-amber-50 rounded-2xl p-8 shadow-xl border-4 border-amber-600 fade-in">
           <h2 class="text-2xl font-bold text-center mb-6 text-amber-900">ğŸ¤  åŠ å…¥æ¢éšªéšŠ</h2>
            
            <div id="login-step-1">
                <div class="mb-6">
                    <label class="block text-amber-800 font-bold mb-2">è¼¸å…¥ç­ç´šä»£ç¢¼</label>
                    <input type="text" id="login-class-id" class="w-full p-4 border-2 border-amber-300 rounded-xl text-center text-2xl font-bold uppercase" placeholder="è€å¸«çµ¦çš„ä»£ç¢¼">
                </div>
                <button onclick="app.checkClassExists()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg text-xl">ä¸‹ä¸€æ­¥ â¡ï¸</button>
            </div>

            <div id="login-step-2" class="hidden">
                <div class="mb-4">
                    <label class="block text-amber-800 font-bold mb-2">ä½ çš„å§“å (åº§è™Ÿ+åå­—)</label>
                    <input type="text" id="login-student-name" class="w-full p-3 border-2 border-amber-300 rounded-xl text-center text-xl" placeholder="ä¾‹: 25å°ç¿°">
                </div>
                <div class="mb-6">
                    <label class="block text-amber-800 font-bold mb-2">é¸æ“‡æ¢éšªå°çµ„</label>
                    <div id="team-select-container" class="grid grid-cols-3 gap-3">
                        </div>
                </div>
                <button onclick="app.joinGame()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg text-xl">ğŸš€ é–‹å§‹å†’éšª</button>
            </div>
            <button onclick="app.backToRole()" class="mt-4 w-full text-amber-700 font-bold py-2">â¬…ï¸ è¿”å›</button>
        </div>

        <div id="game-board" class="hidden fade-in">
            <div class="flex flex-wrap justify-between items-center mb-4 bg-white/80 backdrop-blur rounded-xl p-3 shadow border border-amber-200">
                <div class="flex items-center gap-3">
                    <span class="bg-amber-200 text-amber-900 px-3 py-1 rounded-full font-bold">ç­ç´š: <span id="display-class-id">--</span></span>
                    <span class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full font-bold" id="user-identity">--</span>
                </div>
                <div class="flex items-center gap-3 mt-2 md:mt-0">
                    <button id="voice-toggle-btn" class="hidden bg-gray-200 px-3 py-1 rounded-full text-sm font-bold" onclick="app.toggleVoice()">ğŸ”‡ èªéŸ³é—œ</button>
                    <button class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold border border-red-200" onclick="location.reload()">ç™»å‡º</button>
                </div>
            </div>

            <div class="tablet-layout">
                <div class="tablet-left flex flex-col gap-4">
                    <div class="bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300">
                        <div id="game-status-text" class="text-xl font-bold text-amber-800">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                        <div id="timer-display" class="hidden mt-2 text-4xl font-black text-red-600 font-mono drop-shadow-sm">30</div>
                    </div>

                    <div class="relative bg-amber-50/50 rounded-2xl p-4 min-h-[400px] flex flex-col items-center justify-center border-2 border-amber-200">
                        <div id="pyramid-board" class="w-full max-w-[320px] mx-auto scale-90 origin-top">
                            </div>
                    </div>

                    <div class="grid grid-cols-4 gap-1 text-xs text-center font-bold text-white">
                        <div class="bg-black/80 rounded p-1">é»‘:<span id="count-black">0</span></div>
                        <div class="bg-red-600 rounded p-1">ç´…:<span id="count-red">0</span></div>
                        <div class="bg-blue-600 rounded p-1">è—:<span id="count-blue">0</span></div>
                        <div class="bg-yellow-400 text-black rounded p-1">é»ƒ:<span id="count-yellow">0</span></div>
                    </div>
                </div>

                <div class="tablet-right flex flex-col h-full">
                    
                    <div id="panel-teacher" class="hidden bg-white rounded-2xl p-6 shadow-lg border-2 border-amber-600 h-full">
                        <h3 class="text-xl font-bold text-amber-900 mb-4 border-b pb-2">ğŸ® æ³•è€ç‹æ§åˆ¶å°</h3>
                        
                        <div class="flex justify-center gap-4 mb-6 p-4 bg-amber-50 rounded-xl">
                            <div id="t-dice-8" class="w-16 h-16 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-3xl font-black shadow">-</div>
                            <div id="t-dice-10" class="w-16 h-16 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-3xl font-black shadow">-</div>
                            <div id="t-dice-12" class="w-16 h-16 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-3xl font-black shadow">-</div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button id="btn-roll" onclick="app.teacherRollDice()" class="col-span-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white py-4 rounded-xl font-bold text-xl shadow hover:scale-105 transition-transform">ğŸ² æ“²éª°å­</button>
                            <button onclick="app.teacherGetHint()" class="bg-indigo-600 text-white py-3 rounded-xl font-bold shadow hover:bg-indigo-700">ğŸ”® æ³•è€ç‹æç¤º</button>
                            <button onclick="app.forceNextRound()" class="bg-slate-600 text-white py-3 rounded-xl font-bold shadow hover:bg-slate-700">ä¸‹ä¸€å›åˆ (è£œç‰Œ)</button>
                            <button onclick="app.resetGame()" class="col-span-2 bg-red-700 text-white py-3 rounded-xl font-bold shadow hover:bg-red-800">ğŸ—‘ï¸ é‡ç½®éŠæˆ²</button>
                        </div>

                        <div class="mt-auto">
                            <h4 class="font-bold text-amber-800 mb-2">ğŸ† å³æ™‚åˆ†æ•¸</h4>
                            <div id="teacher-scoreboard" class="max-h-[200px] overflow-y-auto space-y-2 text-sm"></div>
                        </div>
                    </div>

                    <div id="panel-student" class="hidden flex flex-col h-full gap-3">
                        
                        <div class="bg-white rounded-xl p-4 shadow border-2 border-amber-300">
                             <div class="flex justify-center gap-3 mb-3">
                                <button onclick="app.inputChar(app.state.dice.d8)" id="s-dice-8" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d10)" id="s-dice-10" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d12)" id="s-dice-12" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                            </div>
                            
                            <div class="relative">
                                <input type="text" id="formula-input" class="w-full p-3 pl-4 pr-12 text-center text-2xl font-bold tracking-widest bg-slate-50 border-2 border-indigo-200 rounded-lg formula-input-readonly focus:outline-none focus:ring-2 focus:ring-indigo-400" readonly placeholder="é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¼¸å…¥">
                                <button onclick="app.backspace()" class="absolute right-2 top-2 bottom-2 px-3 text-red-500 hover:bg-red-50 rounded cursor-control-btn font-bold">âŒ«</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-4 gap-2 flex-grow">
                            <button onclick="app.inputChar('+')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">+</button>
                            <button onclick="app.inputChar('-')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">-</button>
                            <button onclick="app.inputChar('*')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">Ã—</button>
                            <button onclick="app.inputChar('/')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">Ã·</button>
                            
                            <button onclick="app.inputChar('(')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 col-span-2">(</button>
                            <button onclick="app.inputChar(')')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 col-span-2">)</button>

                            <button onclick="app.moveCursor(-1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 col-span-2 active:bg-amber-300">â¬…ï¸</button>
                            <button onclick="app.moveCursor(1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 col-span-2 active:bg-amber-300">â¡ï¸</button>

                            <button onclick="app.submitAnswer()" id="btn-submit" class="col-span-4 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg border-b-4 border-green-800 active:scale-95 active:border-b-0 transition-all mt-2 py-3 disabled:opacity-50 disabled:grayscale">âœ¨ é©—è­‰ç­”æ¡ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="msg-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-opacity opacity-0 pointer-events-none font-bold text-lg text-center w-max max-w-[90%]">
                æç¤ºè¨Šæ¯
            </div>
        </div>
        
        <div id="solution-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
             <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl border-4 border-amber-600 text-center animate-[urgentFloat_0.5s_ease-out]">
                <h3 class="text-2xl font-black text-amber-900 mb-4">ğŸ”® æ³•è€ç‹çš„æç¤º</h3>
                <div class="bg-amber-100 p-4 rounded-xl mb-4">
                    <p class="text-sm text-amber-800 mb-1">å‰å…©å€‹æ•¸å­—çš„é‹ç®—æ˜¯...</p>
                    <p id="solution-hint-text" class="text-3xl font-bold text-indigo-700 font-mono tracking-wider">--</p>
                </div>
                <button onclick="document.getElementById('solution-modal').classList.add('hidden')" class="bg-amber-700 text-white px-6 py-2 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
             </div>
        </div>

    </div>
	<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyDPGUqIx8qWEmKDPaI5Pwnm6nSJ95KjpHg",
        authDomain: "pharaoh-code-v3.firebaseapp.com",
        projectId: "pharaoh-code-v3",
        databaseURL: "https://pharaoh-code-v3-default-rtdb.asia-southeast1.firebasedatabase.app",
        storageBucket: "pharaoh-code-v3.firebasestorage.app",
        messagingSenderId: "884553648676",
        appId: "1:884553648676:web:a30ca4b251a6f4f6da66b1"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯ ---
    const app = {
        state: {
            role: null, // 'teacher' or 'student'
            classId: null,
            myTeam: null,
            myName: null,
            gameData: {},
            cards: {}, // éœæ…‹å¡ç‰‡è³‡æ–™
            voiceEnabled: false,
            localTimer: null,
            selectedCardIndex: null, // å­¸ç”Ÿé¸ä¸­çš„å¡ç‰‡
        },

        // DOM å…ƒç´ å¿«å– (Lazy load)
        el: (id) => document.getElementById(id),

        // --- 1. åˆå§‹åŒ–èˆ‡æµç¨‹ ---
        init: () => {
            app.createPredefinedCards();
            // æª¢æŸ¥ URL æ˜¯å¦å¸¶æœ‰ classId (æ–¹ä¾¿é‡æ–°æ•´ç†å¾Œè‡ªå‹•é‡é€£ï¼Œæ­¤è™•æš«ç•¥ï¼Œä»¥ä»‹é¢ç‚ºä¸»)
        },

        // --- 2. è§’è‰²èˆ‡ç™»å…¥æµç¨‹ ---
        selectRole: (role) => {
            app.state.role = role;
            app.el('page-role-select').classList.add('hidden');
            if (role === 'teacher') {
                app.el('page-teacher-setup').classList.remove('hidden');
            } else {
                app.el('page-student-login').classList.remove('hidden');
                app.el('login-step-1').classList.remove('hidden');
            }
        },

        backToRole: () => {
            app.el('page-teacher-setup').classList.add('hidden');
            app.el('page-student-login').classList.add('hidden');
            app.el('page-role-select').classList.remove('hidden');
            app.state.role = null;
        },

        
        // è€å¸«å»ºç«‹æˆ¿é–“
        createClass: () => {
            const classId = app.el('setup-class-id').value.trim();
            if (!classId) return app.toast('âŒ è«‹è¼¸å…¥ç­ç´šä»£ç¢¼');
            
            app.state.classId = classId;
            const classRef = db.ref(`classes/${classId}`);
            
            // v3.0.2: ç”¢ç”Ÿåˆå§‹è³‡æ–™ (åŒ…å«ç‰Œåº«èˆ‡é‡‘å­—å¡”)
            const initialData = app.generateInitialGameData();

            // åˆå§‹åŒ–éŠæˆ²è³‡æ–™
            classRef.set({
                status: 'waiting', 
                dice: { d8: '-', d10: '-', d12: '-' },
                round: 1,
                timer: 30,
                timerActive: false,
                pyramid: initialData.pyramid, // åˆå§‹é‡‘å­—å¡”
                decks: initialData.decks,     // v3.0.2: å­˜å…¥å‰©é¤˜ç‰Œåº«
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                app.startGameInterface();
            });
        },

        // å­¸ç”Ÿæª¢æŸ¥æˆ¿é–“
        checkClassExists: () => {
            const classId = app.el('login-class-id').value.trim();
            if (!classId) return app.toast('âŒ è«‹è¼¸å…¥ç­ç´šä»£ç¢¼');

            db.ref(`classes/${classId}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    app.state.classId = classId;
                    app.el('login-step-1').classList.add('hidden');
                    app.el('login-step-2').classList.remove('hidden');
                    app.renderTeamButtons(); // æ¸²æŸ“çµ„åˆ¥æŒ‰éˆ•
                } else {
                    app.toast('âŒ æ‰¾ä¸åˆ°æ­¤ç­ç´šï¼Œè«‹ç¢ºèªä»£ç¢¼');
                }
            });
        },

        renderTeamButtons: () => {
            const container = app.el('team-select-container');
            const teams = [
                {id: 1, name: 'ç¬¬1çµ„:é˜¿åŠªæ¯”æ–¯', icon: 'ğŸ•'},
                {id: 2, name: 'ç¬¬2çµ„:è·é­¯æ–¯', icon: 'ğŸ¦…'},
                {id: 3, name: 'ç¬¬3çµ„:å·´æ–¯æ³°ç‰¹', icon: 'ğŸ±'},
                {id: 4, name: 'ç¬¬4çµ„:æ­è¥¿é‡Œæ–¯', icon: 'ğŸ§Ÿ'},
                {id: 5, name: 'ç¬¬5çµ„:ä¼Šè¥¿æ–¯', icon: 'ğŸ¦‹'},
                {id: 6, name: 'ç¬¬6çµ„:å¤ªé™½ç¥æ‹‰', icon: 'ğŸŒ'}
            ];
            let html = '';
            teams.forEach(t => {
                html += `<button onclick="app.selectTeam(${t.id}, this)" class="team-btn bg-white border-2 border-amber-300 text-amber-900 font-bold py-3 rounded-lg hover:bg-amber-50 flex flex-col items-center justify-center text-sm"><span>${t.icon}</span><span>${t.name}</span></button>`;
            });
            container.innerHTML = html;
        },

        selectTeam: (teamId, btnElement) => {
            app.state.myTeam = `team${teamId}`;
            document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('selected', 'bg-amber-100', 'border-amber-600'));
            btnElement.classList.add('selected', 'bg-amber-100', 'border-amber-600');
        },

        joinGame: () => {
            const name = app.el('login-student-name').value.trim();
            if (!name) return app.toast('âŒ è«‹è¼¸å…¥å§“å (åº§è™Ÿ+åå­—)');
            if (!app.state.myTeam) return app.toast('âŒ è«‹é¸æ“‡æ¢éšªå°çµ„');

            app.state.myName = name;
            
            // è¨»å†Šå­¸ç”Ÿè³‡æ–™åˆ° Firebase
            const playerRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${name}`);
            playerRef.update({
                name: name,
                score: 0, // åˆå§‹åˆ†æ•¸ï¼Œå¦‚æœå·²å­˜åœ¨ä¸è¦†è“‹
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });

            app.startGameInterface();
        },

        // --- 3. éŠæˆ²ä»‹é¢èˆ‡åŒæ­¥ ---
        startGameInterface: () => {
            // éš±è—ç™»å…¥é ï¼Œé¡¯ç¤ºä¸»éŠæˆ²å€
            app.el('page-teacher-setup').classList.add('hidden');
            app.el('page-student-login').classList.add('hidden');
            app.el('game-board').classList.remove('hidden');
            
            // è¨­ç½®è³‡è¨Šåˆ—
            app.el('display-class-id').textContent = app.state.classId;
            app.el('user-identity').textContent = app.state.role === 'teacher' ? 'ğŸ‘‘ è€å¸«' : `ğŸ¤  ${app.state.myName}`;

            // æ ¹æ“šè§’è‰²é¡¯ç¤ºé¢æ¿
            if (app.state.role === 'teacher') {
                app.el('panel-teacher').classList.remove('hidden');
                app.el('voice-toggle-btn').classList.remove('hidden');
            } else {
                app.el('panel-student').classList.remove('hidden');
            }

            // å•Ÿå‹• Firebase ç›£è½
            app.listenToGameData();
			// --- è€å¸«ç«¯å°ˆç”¨ï¼šé©…å‹•å…¨åŸŸè¨ˆæ™‚å™¨ ---
            if (app.state.role === 'teacher') {
                setInterval(() => {
                    if (app.state.gameData && app.state.gameData.timerActive && app.state.gameData.timer > 0) {
                        const newTime = app.state.gameData.timer - 1;
                        db.ref(`classes/${app.state.classId}/timer`).set(newTime);
                        
                        // å€’æ•¸ 10 ç§’è­¦å‘ŠéŸ³
                        if (newTime <= 10 && newTime > 0) app.speak(newTime.toString());
                        if (newTime === 0) {
                            app.handleTimeUp(); // è€å¸«ç«¯è™•ç†çµæŸ
                            db.ref(`classes/${app.state.classId}/timerActive`).set(false);
                        }
                    }
                }, 1000);
            }
        },

        listenToGameData: () => {
            const classRef = db.ref(`classes/${app.state.classId}`);
            
            classRef.on('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;
                
                app.state.gameData = data;
                app.updateUI(data);
            });
        },

        // --- 4. UI æ›´æ–°é‚è¼¯ ---
      updateUI: (data) => {
            // 1. åŸºæœ¬ç‹€æ…‹æ–‡å­—èˆ‡æ¨£å¼é‡ç½®
            const statusEl = app.el('game-status-text');
            const statusBox = statusEl.parentElement;
            
            // é è¨­æ¨£å¼ (æ¯æ¬¡æ›´æ–°å…ˆé‚„åŸï¼Œé¿å…å¡åœ¨è­¦å‘Šç‹€æ…‹)
            statusBox.className = "bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300 transition-colors duration-300";
            statusEl.className = "text-xl font-bold text-amber-800";
            
            const statusMap = {
                'waiting': 'ç­‰å¾…æ³•è€ç‹é–‹å•Ÿè©¦ç…‰...',
                'rolling': 'ğŸ² å‘½é‹ä¹‹éª°è½‰å‹•ä¸­...',
                'playing': 'âœ¨ è©¦ç…‰é€²è¡Œä¸­ - ç ´è§£åœ–é¨°ï¼',
                'ended': 'ğŸ è©¦ç…‰çµæŸ'
            };
            statusEl.textContent = statusMap[data.status] || data.status;

            // æ›´æ–°éª°å­
            app.updateDiceUI(data.dice);

            // æ›´æ–°é‡‘å­—å¡”
            app.renderPyramid(data.pyramid);

            // æ›´æ–°è¨ˆæ™‚å™¨
            if (data.timerActive) {
                app.el('timer-display').classList.remove('hidden');
                app.el('timer-display').textContent = data.timer;
                if(data.timer === 0) app.handleTimeUp(); 
            } else {
                app.el('timer-display').classList.add('hidden');
            }
            
            // æŒ‰éˆ•é–å®šé‚è¼¯
            const btnRoll = app.el('btn-roll');
            if (app.state.role === 'teacher') {
                if (data.status === 'waiting' || data.status === 'ended') {
                    btnRoll.disabled = false;
                    btnRoll.classList.remove('btn-disabled');
                    btnRoll.textContent = "ğŸ² æ“²éª°å­";
                } else {
                    btnRoll.disabled = true;
                    btnRoll.classList.add('btn-disabled');
                    btnRoll.textContent = (data.status === 'rolling') ? "ğŸ² è½‰å‹•ä¸­..." : "ğŸ”’ é–å®šä¸­";
                }
                
                app.renderTeacherScoreboard(data.players);

                // v3.0.6: æ­»å±€æª¢æŸ¥ (Deadlock Check)
                // åªè¦ç‹€æ…‹æ˜¯ playingï¼Œç„¡è«–æ˜¯å¦åœ¨å€’æ•¸(timerActive)ï¼Œéƒ½è¦æª¢æŸ¥
                if (data.status === 'playing') {
                    const currentDice = [data.dice.d8, data.dice.d10, data.dice.d12];
                    // å–å¾—å ´ä¸Šå‰©é¤˜ç›®æ¨™
                    const remainingTargets = data.pyramid
                        .filter(c => c && !c.isTaken)
                        .map(c => c.number);
                    
                    if (remainingTargets.length > 0) {
                        let hasSolution = false;
                        for (let target of remainingTargets) {
                            if (app.findSolution(currentDice, target)) {
                                hasSolution = true;
                                break;
                            }
                        }
                        
                        // è‹¥å…¨å ´ç„¡è§£ï¼Œæ”¹è®Šä¸Šæ–¹ç‹€æ…‹æ¬„æ¨£å¼
                        if (!hasSolution) {
                            statusBox.className = "bg-yellow-400 rounded-2xl p-4 shadow-xl text-center relative border-4 border-black animate-pulse";
                            statusEl.className = "text-2xl font-black text-black";
                            // ä¿ç•™å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºï¼Œä½†æ–‡å­—æ”¹ç‚ºè­¦å‘Š
                            if (data.timerActive) {
                                statusEl.innerHTML = `âš ï¸ è­¦å‘Šï¼šå ´ä¸Šå·²ç„¡å¯è§£æ•¸å­—ï¼<br><span class="text-base font-medium">è«‹ç­‰å¾…å€’æ•¸çµæŸæˆ–æ‰‹å‹•ä¸‹ä¸€å±€</span>`;
                            } else {
                                statusEl.innerHTML = `âš ï¸ è­¦å‘Šï¼šå ´ä¸Šå·²ç„¡å¯è§£æ•¸å­—ï¼<br><span class="text-base font-medium">å»ºè­°ç›´æ¥æŒ‰ã€Œä¸‹ä¸€å›åˆã€</span>`;
                            }
                        }
                    }
                }
            }
        },

        updateDiceUI: (dice) => {
            // è€å¸«ç«¯
            app.el('t-dice-8').textContent = dice.d8;
            app.el('t-dice-10').textContent = dice.d10;
            app.el('t-dice-12').textContent = dice.d12;
            
            // å­¸ç”Ÿç«¯
            app.el('s-dice-8').textContent = dice.d8;
            app.el('s-dice-10').textContent = dice.d10;
            app.el('s-dice-12').textContent = dice.d12;
            
            // è¨˜éŒ„ç•¶å‰éª°å­å€¼åˆ° state æ–¹ä¾¿è¼¸å…¥
            app.state.dice = dice;
        },

       renderPyramid: (pyramidData) => {
            const board = app.el('pyramid-board');
            if (!pyramidData) return;
            
            // å®šç¾©çµ±ä¸€çš„å¡ç‰‡å°ºå¯¸é¡åˆ¥ (åŠ å…¥ flex-shrink-0 é˜²æ­¢è¢«æ“ å£“è®Šå½¢)
            // v3.0.6: çµ±ä¸€å°ºå¯¸ w-20 h-24 (æ‰‹æ©Ÿ) / w-24 h-28 (å¹³æ¿ä»¥ä¸Š)
            const cardSizeClass = "w-20 h-24 md:w-24 md:h-28 flex-shrink-0";
            
            // 10å¼µå¡ç‰‡çš„çµæ§‹: [0], [1,2], [3,4,5], [6,7,8,9]
            const rows = [[0], [1,2], [3,4,5], [6,7,8,9]];
            let html = '';
            
            rows.forEach(rowIndices => {
                html += '<div class="flex justify-center mb-3 gap-2">'; // ä½¿ç”¨ gap-2 çµ±ä¸€é–“è·
                rowIndices.forEach(idx => {
                    const card = pyramidData[idx];
                    if (card) {
                        const isSelected = app.state.selectedCardIndex === idx;
                        const ringClass = isSelected ? 'ring-4 ring-green-500 scale-110 z-10' : '';
                        const colorClass = app.getCardColorClass(card.color);
                        const visibilityClass = card.isTaken ? 'opacity-0 pointer-events-none' : 'opacity-100';
                        
                        // å¡ç‰‡æœ¬é«”
                        html += `<div onclick="app.studentSelectCard(${idx})" class="${cardSizeClass} rounded-xl shadow-lg cursor-pointer transition-all duration-200 ${colorClass} ${ringClass} ${visibilityClass} flex items-center justify-center font-black relative border-2 border-white/20"><div class="absolute top-1 right-2 text-sm opacity-60 font-bold">${card.points}</div><span class="pyramid-num-lg drop-shadow-md">${card.number}</span></div>`;
                    } else {
                        // ç©ºä½ (å¿…é ˆä½¿ç”¨ç›¸åŒçš„ cardSizeClass ç¢ºä¿å¤§å°ä¸€è‡´)
                        html += `<div class="${cardSizeClass} rounded-xl border-4 border-dashed border-amber-300/50 bg-white/20"></div>`;
                    }
                });
                html += '</div>';
            });

            board.innerHTML = html;
            
            // æ›´æ–°å¡ç‰‡å‰©é¤˜æ•¸é‡
            const decks = app.state.gameData.decks || {};
            const counts = {
                black: decks.black ? decks.black.length : 0,
                red: decks.red ? decks.red.length : 0,
                blue: decks.blue ? decks.blue.length : 0,
                yellow: decks.yellow ? decks.yellow.length : 0
            };
            app.el('count-black').textContent = counts.black;
            app.el('count-red').textContent = counts.red;
            app.el('count-blue').textContent = counts.blue;
            app.el('count-yellow').textContent = counts.yellow;
        },

        studentSelectCard: (index) => {
            if (app.state.role !== 'student') return;
            if (app.state.gameData.status !== 'playing') {
                app.toast('âœ‹ ç¾åœ¨é‚„ä¸èƒ½é¸å¡ç‰‡å–”');
                return;
            }
            
            app.state.selectedCardIndex = index;
           // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé¸å–æ¡†
            app.renderPyramid(app.state.gameData.pyramid);
            
            // èšç„¦è¼¸å…¥æ¡† (ä¿®æ­£: ä¿ç•™åŸæœ¬è¼¸å…¥çš„å…¬å¼ï¼Œä¸ä¸»å‹•æ¸…ç©º)
            app.el('formula-input').focus();
            app.toast(`å·²é¸æ“‡ç›®æ¨™ï¼š${app.state.gameData.pyramid[index].number}`);
        },

        // --- 5. è€å¸«æ§åˆ¶åŠŸèƒ½ ---
        /* --- è€å¸«æ“²éª°èˆ‡è§£æ³•é©—è­‰é–‹å§‹ --- */
		/* --- v3.0.2 æ–°å¢: æ³•è€ç‹æç¤º --- */
        teacherGetHint: () => {
            if (app.state.gameData.status !== 'playing') return app.toast('âš ï¸ è«‹å…ˆæ“²éª°å­ä¸¦é–‹å§‹éŠæˆ²');
            
            const d8 = app.state.gameData.dice.d8;
            const d10 = app.state.gameData.dice.d10;
            const d12 = app.state.gameData.dice.d12;
            
            // ä½¿ç”¨ AI è§£é¡Œ
            const solution = app.findSolution([d8, d10, d12]);
            
            if (solution) {
                // æç¤ºè¦å‰‡ï¼šåªé¡¯ç¤ºå‰å…©å€‹æ•¸å­—çš„é‹ç®—
                // Regex: å°‹æ‰¾ "æ•¸å­— é‹ç®—ç¬¦ æ•¸å­—" çš„çµæ§‹ (ä¾‹å¦‚ 3 + 4)
                // æ’é™¤å¤–åœæ‹¬è™Ÿï¼ŒæŠ“å–æ ¸å¿ƒé‹ç®—
                const match = solution.match(/(\d+\s*[\+\-\*\/]\s*\d+)/);
                let hint = solution;
                if (match) {
                    hint = match[0]; // æŠ“å–åˆ°çš„ç¬¬ä¸€çµ„é‹ç®—ï¼Œå¦‚ "3 + 4" æˆ– "7 * 3"
                }
                
                // é¡¯ç¤ºæ¨¡æ…‹çª—
                const modal = app.el('solution-modal');
                const hintText = app.el('solution-hint-text');
                hintText.textContent = `(${hint}) ... ?`;
                modal.classList.remove('hidden');
                app.speak("æ³•è€ç‹æç¤ºï¼š" + hint);
            } else {
                app.toast("âš ï¸ ç›®å‰çš„éª°å­ä¼¼ä¹ç„¡è§£...");
            }
        },
      /* --- v3.0.4 å„ªåŒ–: æ“²éª°å‹•ç•« + æ­»å±€è‡ªå‹•é‡ç½® --- */
        teacherRollDice: () => {
            if (app.state.gameData.status === 'rolling' || app.state.gameData.status === 'playing') return;

            // 1. è¨­å®šç‚ºæ»¾å‹•ç‹€æ…‹ (é–å®šæŒ‰éˆ•å·²ç”± updateUI è™•ç†ï¼Œé€™è£¡åŒæ­¥é›²ç«¯ç‹€æ…‹)
            db.ref(`classes/${app.state.classId}`).update({
                status: 'rolling',
                dice: { d8: '?', d10: '?', d12: '?' }
            });
            
            // æ’­æ”¾æ»¾å‹•éŸ³æ•ˆæˆ–èªéŸ³
            if (app.state.voiceEnabled) app.speak("å‘½é‹ä¹‹éª°è½‰å‹•ä¸­...");

            // v3.0.5: æœ¬åœ°ç«¯æ»¾å‹•å‹•ç•« (è¦–è¦ºæ•ˆæœ)
            const rollInterval = setInterval(() => {
                app.el('t-dice-8').textContent = Math.floor(Math.random() * 8) + 1;
                app.el('t-dice-10').textContent = Math.floor(Math.random() * 10) + 1;
                app.el('t-dice-12').textContent = Math.floor(Math.random() * 12) + 1;
            }, 80);

            // 2. å»¶é² 1.5 ç§’å¾Œç”¢ç”Ÿæœ€çµ‚çµæœ
            setTimeout(() => {
                clearInterval(rollInterval); // åœæ­¢å‹•ç•«
                
                // ç”¢ç”Ÿæœ€çµ‚æ•¸å€¼ (ç¬¦åˆè¦å‰‡: 8é¢, 10é¢, 12é¢)
                const d8 = Math.floor(Math.random() * 8) + 1;
                const d10 = Math.floor(Math.random() * 10) + 1;
                const d12 = Math.floor(Math.random() * 12) + 1;
                const diceArr = [d8, d10, d12];

                // ç²å–ç‰ˆé¢ä¸Šæœ‰æ•ˆå¡ç‰‡
                const activeTargets = app.state.gameData.pyramid
                    .filter(card => card && !card.isTaken)
                    .map(card => card.number);

                // 3. æª¢æŸ¥æ˜¯å¦æœ‰è§£
                let hasSolution = false;
                for (let target of activeTargets) {
                    if (app.findSolution(diceArr, target)) {
                        hasSolution = true;
                        break;
                    }
                }

                if (!hasSolution) {
                    // ç„¡è§£ï¼šå…ˆé¡¯ç¤ºé»æ•¸ï¼Œ3ç§’å¾Œè‡ªå‹•ä¸‹ä¸€å±€
                    db.ref(`classes/${app.state.classId}/dice`).update({ d8, d10, d12 });
                    app.speak(`æ“²å‡º ${d8}, ${d10}, ${d12}ã€‚è«¸ç¥æ²ˆé»˜ï¼Œæ­¤å±€ç„¡è§£ï¼`);
                    app.toast(`âŒ é»æ•¸ ${d8}, ${d10}, ${d12} ç„¡æ³•ç ´è§£åœ–é¨°ï¼Œ3ç§’å¾Œé€²å…¥ä¸‹ä¸€è¼ª...`);
                    
                    setTimeout(() => {
                        app.forceNextRound();
                    }, 3000);
                } else {
                    // æœ‰è§£ï¼šæ­£å¼é–‹å§‹
                    db.ref(`classes/${app.state.classId}`).update({
                        status: 'playing',
                        dice: { d8, d10, d12 },
                        timerActive: false,
                        timer: 30
                    });
                    if (app.state.voiceEnabled) app.speak(`æ“²éª°çµæœï¼š${d8}ã€${d10}ã€${d12}ã€‚è©¦ç…‰é–‹å§‹ï¼`);
                }
            }, 1500); // 1.5ç§’å‹•ç•«æ™‚é–“
        },
        /* --- è€å¸«æ“²éª°èˆ‡è§£æ³•é©—è­‰çµæŸ --- */
        
        forceNextRound: () => {
             // v3.0.2: è£œæ»¿é‡‘å­—å¡”é‚è¼¯
             const gameData = app.state.gameData;
             if (!gameData || !gameData.decks) return app.toast('âš ï¸ è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œ...');

             const newPyramid = [...(gameData.pyramid || [])];
             const newDecks = JSON.parse(JSON.stringify(gameData.decks)); // æ·±æ‹·è²ä»¥å…ç›´æ¥ä¿®æ”¹ state
             let isGameOver = false;
             let hasRefilled = false;

             // éæ­·é‡‘å­—å¡” 10 å€‹ä½ç½®
             // è¦å‰‡: 0(é»‘), 1-2(ç´…), 3-5(è—), 6-9(é»ƒ)
             const slots = [
                 {idx:0, color:'black'},
                 {idx:1, color:'red'}, {idx:2, color:'red'},
                 {idx:3, color:'blue'}, {idx:4, color:'blue'}, {idx:5, color:'blue'},
                 {idx:6, color:'yellow'}, {idx:7, color:'yellow'}, {idx:8, color:'yellow'}, {idx:9, color:'yellow'}
             ];

             slots.forEach(slot => {
                 // å¦‚æœè©²ä½ç½®æ˜¯ç©ºçš„ (null) æˆ–å·²è¢«æ‹¿èµ° (isTaken)ï¼Œå˜—è©¦è£œç‰Œ
                 if (!newPyramid[slot.idx] || newPyramid[slot.idx].isTaken) {
                     // æª¢æŸ¥å°æ‡‰é¡è‰²çš„ç‰Œåº«æ˜¯å¦é‚„æœ‰ç‰Œ
                     if (newDecks[slot.color] && newDecks[slot.color].length > 0) {
                         // æŠ½ä¸€å¼µç‰Œ
                         const nextCard = newDecks[slot.color].pop(); 
                         // è¨­å®šåˆ°é‡‘å­—å¡”
                         newPyramid[slot.idx] = nextCard;
                         hasRefilled = true;
                     } else {
                         // è©²é¡è‰²æ²’ç‰Œäº†ï¼Œè¨­å®šç‚º null (æ°¸ä¹…ç©ºç¼º)
                         newPyramid[slot.idx] = null;
                     }
                 }
             });

             // æª¢æŸ¥æ˜¯å¦å®Œå…¨æ²’ç‰Œäº† (é‡‘å­—å¡”å…¨ç©º ä¸” æ‰€æœ‰ç‰Œåº«å…¨ç©º -> å…¶å¯¦åªè¦é‡‘å­—å¡”å…¨ç©ºé€šå¸¸å°±ç„¡æ³•éŠæˆ²äº†ï¼Œæˆ–æ˜¯æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ä½ç½®éƒ½ç‚º null)
             const isPyramidEmpty = newPyramid.every(p => p === null);
             if (isPyramidEmpty) {
                 isGameOver = true;
             }

             if (isGameOver) {
                 db.ref(`classes/${app.state.classId}`).update({
                     status: 'ended',
                     timerActive: false
                 });
                 app.toast('ğŸ ç‰Œåº«å·²ç©ºï¼ŒéŠæˆ²çµæŸï¼');
             } else {
                 // æ›´æ–° Firebase
                 db.ref(`classes/${app.state.classId}`).update({
                     status: 'waiting',
                     dice: {d8:'-', d10:'-', d12:'-'},
                     timerActive: false,
                     pyramid: newPyramid,
                     decks: newDecks,
                     round: (gameData.round || 1) + 1
                 });
                 app.toast(hasRefilled ? 'å·²é€²å…¥ä¸‹ä¸€å›åˆä¸¦è£œç‰Œ' : 'å·²é€²å…¥ä¸‹ä¸€å›åˆ (ç„¡ç‰Œå¯è£œ)');
             }
        },
        
        resetGame: () => {
             if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰éŠæˆ²é€²åº¦å—ï¼Ÿ')) {
                 app.createClass(); // é‡æ–°åˆå§‹åŒ–è³‡æ–™
             }
        },

        renderTeacherScoreboard: (players) => {
            const list = app.el('teacher-scoreboard');
            if (!players) { list.innerHTML = '<div class="text-center text-gray-400">å°šç„¡ç©å®¶åŠ å…¥</div>'; return; }
            
            // æ‰å¹³åŒ–ç©å®¶è³‡æ–™: {team, name, score}
            let allPlayers = [];
            Object.keys(players).forEach(teamKey => {
                const teamPlayers = players[teamKey];
                Object.values(teamPlayers).forEach(p => {
                    allPlayers.push({...p, team: teamKey});
                });
            });

            allPlayers.sort((a, b) => b.score - a.score);

            // ç„¡ç©ºç™½æ¸²æŸ“
            let html = '';
            allPlayers.forEach((p, i) => {
                const icon = i===0 ? 'ğŸ‘‘' : '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-200"><div class="flex items-center gap-2"><span class="font-bold w-6">${i+1}.</span><span>${p.name} (${app.getTeamName(p.team)})</span></div><span class="font-bold text-amber-700">${p.score}åˆ† ${icon}</span></div>`;
            });
            list.innerHTML = html;
        },
        
       getTeamName: (key) => {
            const map = {
                team1: 'é˜¿åŠªæ¯”æ–¯', team2: 'è·é­¯æ–¯', team3: 'å·´æ–¯æ³°ç‰¹',
                team4: 'æ­è¥¿é‡Œæ–¯', team5: 'ä¼Šè¥¿æ–¯', team6: 'å¤ªé™½ç¥æ‹‰'
            };
            return map[key] || key;
        },

        // --- 6. å­¸ç”Ÿè¼¸å…¥èˆ‡æ–¹å‘éµé‚è¼¯ ---
        inputChar: (char) => {
            if (app.state.role !== 'student') return;
            const input = app.el('formula-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;

            // åœ¨æ¸¸æ¨™è™•æ’å…¥
            input.value = value.substring(0, start) + char + value.substring(end);
            
            // ç§»å‹•æ¸¸æ¨™åˆ°æ’å…¥å­—å…ƒå¾Œ
            const newPos = start + String(char).length;
            input.setSelectionRange(newPos, newPos);
            input.focus();
        },

        backspace: () => {
             const input = app.el('formula-input');
             const start = input.selectionStart;
             const end = input.selectionEnd;
             const value = input.value;
             
             if (start === end && start > 0) {
                 input.value = value.substring(0, start - 1) + value.substring(end);
                 input.setSelectionRange(start - 1, start - 1);
             } else if (start !== end) {
                 input.value = value.substring(0, start) + value.substring(end);
                 input.setSelectionRange(start, start);
             }
             input.focus();
        },

        moveCursor: (direction) => {
            const input = app.el('formula-input');
            const currentPos = input.selectionStart;
            const newPos = direction === -1 ? Math.max(0, currentPos - 1) : Math.min(input.value.length, currentPos + 1);
            input.setSelectionRange(newPos, newPos);
            input.focus();
        },

      /* --- å­¸ç”Ÿè§£é¡Œèˆ‡åŒæ­¥å€’æ•¸é‚è¼¯ (å« v3.0.4 æ­»å±€æª¢æŸ¥) --- */
        submitAnswer: () => {
            const idx = app.state.selectedCardIndex;
            if (idx === null) return app.toast('âš ï¸ è«‹å…ˆé»æ“Šé‡‘å­—å¡”ä¸Šçš„æ•¸å­—ï¼');
            
            const card = app.state.gameData.pyramid[idx];
            if (!card || card.isTaken) return app.toast('ğŸš« æ™šäº†ä¸€æ­¥ï¼é€™å¼µç‰Œå·²ç¶“è¢«æ‹¿èµ°äº†ã€‚');
            
            const formula = app.el('formula-input').value;
            const diceNums = [app.state.dice.d8, app.state.dice.d10, app.state.dice.d12].sort((a,b)=>a-b);
            const formulaNums = (formula.match(/\d+/g) || []).map(Number).sort((a,b)=>a-b);
            
            if (JSON.stringify(diceNums) !== JSON.stringify(formulaNums)) {
                return app.toast('âŒ æ•¸å­—ä½¿ç”¨éŒ¯èª¤ï¼å¿…é ˆç”¨å®Œä¸‰é¡†éª°å­ã€‚');
            }

            try {
                const cleanFormula = formula.replace(/[^-()\d/*+.]/g, '');
                const result = new Function(`return ${cleanFormula}`)();
                
                if (Math.abs(result - card.number) < 0.001) {
                    // --- ç­”å°äº†ï¼å•Ÿå‹• Firebase åŒæ­¥æ›´æ–° ---
                    const updates = {};
                    
                    // 1. æ¨™è¨˜å¡ç‰‡å·²è¢«æ‹¿èµ°
                    updates[`pyramid/${idx}/isTaken`] = true;
                    
                    // 2. åŠ åˆ†
                    const scorePath = `players/${app.state.myTeam}/${app.state.myName}/score`;
                    const currentScore = (app.state.gameData.players[app.state.myTeam][app.state.myName].score || 0);
                    updates[scorePath] = currentScore + card.points;
                    
                    // 3. è™•ç†å€’æ•¸è¨ˆæ™‚èˆ‡æ­»å±€æª¢æŸ¥
                    if (!app.state.gameData.timerActive) {
                        updates['timerActive'] = true;
                        updates['timer'] = 30;
                        app.speak("ç ´è§£æˆåŠŸï¼å•Ÿå‹•æœ€å¾Œ 30 ç§’æ’¤é€€æ™‚é–“ï¼");
                    } else {
                        app.speak("æ¼‚äº®ï¼å†æ‹¿ä¸‹ä¸€å¼µç‰Œï¼");
                    }
                    
                    // v3.0.4: æª¢æŸ¥æ‹¿èµ°é€™å¼µç‰Œå¾Œï¼Œå ´ä¸Šå‰©ä¸‹çš„ç‰Œæ˜¯å¦é‚„æœ‰è§£ï¼Ÿ
                    // å»ºç«‹ä¸€å€‹æ¨¡æ“¬çš„é‡‘å­—å¡”ç‹€æ…‹ (å°‡ç•¶å‰å¡ç‰‡è¨­ç‚º taken)
                    const tempPyramid = [...app.state.gameData.pyramid];
                    tempPyramid[idx] = {...card, isTaken: true};
                    
                    // æª¢æŸ¥å‰©ä¸‹çš„æœ‰æ•ˆå¡ç‰‡
                    const remainingTargets = tempPyramid
                        .filter(c => c && !c.isTaken)
                        .map(c => c.number);
                    
                    let hasRemainingSolution = false;
                    const currentDice = [app.state.dice.d8, app.state.dice.d10, app.state.dice.d12];
                    
                    // ä½¿ç”¨ app.findSolution æª¢æŸ¥å‰©é¤˜ç›®æ¨™
                    // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘éœ€è¦å‚³å…¥ç‰¹å®šç›®æ¨™åˆ—è¡¨çµ¦ findSolutionï¼Œä½†åŸæœ¬å‡½å¼è¨­è¨ˆæ˜¯è®€å– state
                    // ç‚ºäº†ç°¡ä¾¿ï¼Œæˆ‘å€‘ç›´æ¥åœ¨é€™è£¡åšä¸€å€‹ç°¡å–®è¿´åœˆå‘¼å« findSolution
                    // ç”±æ–¼ findSolution é è¨­è®€å– app.state.gameDataï¼Œæˆ‘å€‘æš«æ™‚ç„¡æ³•å‚³å…¥æ¨¡æ“¬è³‡æ–™
                    // å› æ­¤æˆ‘å€‘ç¨å¾®ä¿®æ”¹ç­–ç•¥ï¼šå…ˆæ›´æ–° Firebaseï¼Œå¦‚æœä¹‹å¾Œç™¼ç¾ç„¡è§£ï¼Œç”±å„å€‹å®¢æˆ¶ç«¯çš„ updateUI æˆ– timer è™•ç†ï¼Ÿ
                    // ä¸ï¼Œæœ€å¥½æ˜¯å¯«å…¥ä¸€å€‹ç‹€æ…‹ã€‚
                    
                    // ä¿®æ­£ç­–ç•¥ï¼šç›´æ¥éæ­· remainingTargetsï¼Œå¦‚æœ findSolution(dice, target) å›å‚³ true å‰‡ä»£è¡¨é‚„æœ‰æ•‘
                    for (let target of remainingTargets) {
                        if (app.findSolution(currentDice, target)) {
                            hasRemainingSolution = true;
                            break;
                        }
                    }

                    if (!hasRemainingSolution && remainingTargets.length > 0) {
                        // å¦‚æœé‚„æœ‰ç‰Œä½†ç„¡è§£äº†ï¼Œé€šçŸ¥å¤§å®¶
                        // é›–ç„¶ Firebase update æ˜¯éåŒæ­¥çš„ï¼Œä½†æˆ‘å€‘å¯ä»¥é æ¸¬çµæœ
                        setTimeout(() => {
                             app.toast("âš ï¸ è­¦å‘Šï¼šå ´ä¸Šå·²ç„¡å¯è§£æ•¸å­—ï¼");
                             // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦ç›´æ¥å¼·åˆ¶ä¸‹ä¸€å±€ï¼Œæˆ–è€…è®“å€’æ•¸è·‘å®Œ
                             // ä¾ç…§ v2.1 è¦å‰‡ï¼Œæ‡‰è©²æç¤ºä¸¦æ›å±€ã€‚ä½†ç‚ºäº†é¿å…è¡çªï¼Œæˆ‘å€‘è®“è€å¸«ç«¯å»è§¸ç™¼ï¼Œæˆ–è€…é€™è£¡ç›´æ¥è§¸ç™¼ forceNextRound
                             // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘é€™è£¡åªåšæç¤ºï¼Œè®“å€’æ•¸è¨ˆæ™‚å™¨è·‘å®Œè‡ªå‹•æ›å±€ï¼Œæˆ–æ˜¯ç­‰å¾…è€å¸«æŒ‰ä¸‹ä¸€å±€
                             // æˆ–è€…æ˜¯å¯«å…¥ä¸€å€‹ status è®“è€å¸«ç«¯ç›£è½ã€‚
                             // æœ€ç°¡å–®ä½œæ³•ï¼šç›´æ¥å‘¼å« forceNextRound (å› ç‚ºæ‰€æœ‰å®¢æˆ¶ç«¯éƒ½æœ‰æ¬Šé™å¯«å…¥ classes/id)
                             app.forceNextRound();
                        }, 2000); // å»¶é² 2 ç§’è®“å¤§å®¶çœ‹åˆ°ç­”å°çš„è¨Šæ¯
                    }

                    db.ref(`classes/${app.state.classId}`).update(updates);
                    
                    // æ¸…é™¤å­¸ç”Ÿæœ¬åœ°ç‹€æ…‹
                    app.el('formula-input').value = '';
                    app.state.selectedCardIndex = null;
                } else {
                    app.toast(`âŒ è¨ˆç®—çµæœæ˜¯ ${Math.round(result*100)/100}ï¼Œä¸å°å–”ï¼`);
                }
            } catch (e) {
                app.toast('âŒ å…¬å¼å¯«éŒ¯å›‰ï¼Œè«‹æª¢æŸ¥æ‹¬è™Ÿæˆ–ç¬¦è™Ÿã€‚');
            }
        },
        /* --- å­¸ç”Ÿè§£é¡Œèˆ‡åŒæ­¥å€’æ•¸é‚è¼¯çµæŸ --- */
        
        handleCorrectAnswer: (points) => {
            app.toast('ğŸ‰ ç­”å°äº†ï¼åŠ åˆ†ï¼');
            app.el('formula-input').value = '';
            app.state.selectedCardIndex = null; // é‡ç½®é¸æ“‡
            
            // æ›´æ–° Firebase
            // 1. ç§»é™¤å¡ç‰‡
            const pyramidRef = db.ref(`classes/${app.state.classId}/pyramid/${app.state.selectedCardIndex}`);
            pyramidRef.set(null); // è¨­ç‚º null ä»£è¡¨æ‹¿èµ°
            
            // 2. åŠ åˆ†
            const scoreRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/score`);
            scoreRef.transaction(currentScore => (currentScore || 0) + points);
            
            // 3. è§¸ç™¼å€’æ•¸ (å¦‚æœå°šæœªé–‹å§‹)
            db.ref(`classes/${app.state.classId}`).update({ timerActive: true });
        },

        // --- 7. è¼”åŠ©åŠŸèƒ½ ---
        
        // æ™‚é–“åˆ°é‚è¼¯èˆ‡æ–°ç‰ˆæç¤º
      // æ™‚é–“åˆ°é‚è¼¯
        handleTimeUp: () => {
            const modal = app.el('solution-modal');
            const hintText = app.el('solution-hint-text');
            
            const d8 = app.state.gameData.dice.d8;
            const d10 = app.state.gameData.dice.d10;
            const d12 = app.state.gameData.dice.d12;
            
            // v3.0.3: é€™è£¡çš„ findSolution å·²ç¶“æœƒéæ¿¾æ‰å·²æ‹¿èµ°çš„ç‰Œ
            const solution = app.findSolution([d8, d10, d12]);
            
            if (solution) {
                const parts = solution.match(/(\d+\s*[\+\-\*\/]\s*\d+)/);
                let hint = solution;
                if (parts) hint = parts[0];
                
                hintText.textContent = `(${hint}) ... ?`;
                modal.classList.remove('hidden');
                app.speak("æ™‚é–“åˆ°ï¼Œæç¤ºæ˜¯ " + hint);
            } else {
                hintText.textContent = "ç„¡è§£";
                modal.classList.remove('hidden');
            }

            // v3.0.3: å€’æ•¸çµæŸå¾Œï¼Œè‹¥æ˜¯è€å¸«èº«åˆ†ï¼Œè‡ªå‹•è§¸ç™¼ä¸‹ä¸€å›åˆ
            if (app.state.role === 'teacher') {
                setTimeout(() => {
                    modal.classList.add('hidden'); // é—œé–‰æç¤ºçª—
                    app.forceNextRound();          // å¼·åˆ¶ä¸‹ä¸€å›åˆ
                }, 5000); // çµ¦å­¸ç”Ÿ 5 ç§’é˜çœ‹æç¤º
            }
        },

        // ç°¡å–®éè¿´è§£é¡Œ
       // ç°¡å–®éè¿´è§£é¡Œ
        findSolution: (nums, specificTarget = null) => {
             const ops = ['+', '-', '*', '/']; 
             
             // v3.0.3: å–å¾—ç›®æ¨™æ•¸å­— (æ’é™¤å·²æ‹¿èµ°çš„å¡ç‰‡)
             // å¦‚æœæœ‰æŒ‡å®š specificTarget (ç”¨æ–¼ teacherRollDice æª¢æŸ¥) å‰‡åªæŸ¥è©²æ•¸å­—
             // å¦å‰‡æŸ¥æ‰€æœ‰ç‰ˆé¢ä¸Šå‰©é¤˜çš„å¡ç‰‡
             let targets = [];
             if (specificTarget !== null) {
                 targets = [specificTarget];
             } else {
                 targets = app.state.gameData.pyramid
                    .filter(c => c && !c.isTaken)
                    .map(c => c.number);
             }
             
             function getPermutations(arr) { if (arr.length === 1) return [arr]; const perms = []; for (let i = 0; i < arr.length; i++) { const first = arr[i], rest = arr.slice(0, i).concat(arr.slice(i + 1)); getPermutations(rest).forEach(sub => perms.push([first, ...sub])); } return perms; }
             
             for (const p of getPermutations(nums)) {
                const [a, b, c] = p;
                for (const op1 of ops) for (const op2 of ops) {
                    try { 
                        // (a op b) op c
                        let f1 = `(${a} ${op1} ${b}) ${op2} ${c}`;
                        let r1 = eval(f1);
                        // ä¿®æ­£æ¯”è¼ƒé‚è¼¯ï¼Œé¿å…æµ®é»æ•¸èª¤å·®
                        if (targets.some(t => Math.abs(t - r1) < 0.001)) return f1;
                        
                        // a op (b op c)
                        let f2 = `${a} ${op1} (${b} ${op2} ${c})`;
                        let r2 = eval(f2);
                        if (targets.some(t => Math.abs(t - r2) < 0.001)) return f2;
                    } catch(e){}
                }
             }
             return null;
        },

        toast: (msg) => {
            const el = app.el('msg-toast');
            el.textContent = msg;
            el.style.opacity = '1';
            el.style.top = '100px';
            setTimeout(() => { el.style.opacity = '0'; el.style.top = '20px'; }, 2000);
            app.speak(msg);
        },

        speak: (text) => {
            if (app.state.role === 'teacher' && app.state.voiceEnabled && window.speechSynthesis) {
                // ç§»é™¤ emoji
                const cleanText = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'zh-TW';
                window.speechSynthesis.speak(u);
            }
        },
        
        toggleVoice: () => {
            app.state.voiceEnabled = !app.state.voiceEnabled;
            app.el('voice-toggle-btn').textContent = app.state.voiceEnabled ? "ğŸ”Š èªéŸ³é–‹" : "ğŸ”‡ èªéŸ³é—œ";
        },

        // ç”¢ç”Ÿåˆå§‹é‡‘å­—å¡”è³‡æ–™ (èˆ‡ v2 ç›¸åŒ)
        generatePredefinedCards: () => { /* èˆ‡ v2 ç›¸åŒï¼Œç¨å¾Œå‘¼å« createPredefinedCards */ },
        getCardColorClass: (c) => { return { black: 'bg-slate-900 text-white', red: 'bg-red-600 text-white', blue: 'bg-blue-600 text-white', yellow: 'bg-yellow-400 text-black' }[c] || 'bg-gray-200'; },
        
      /* --- å›ºå®šç‰Œåº«èˆ‡é‡‘å­—å¡”é‚è¼¯é–‹å§‹ --- */
        // æ´—ç‰Œå‡½å¼
        shuffle: (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        // å–å¾— v2.1.0 å›ºå®šç‰Œåº«ä¸¦åˆå§‹åŒ–ç‰©ä»¶
       // å–å¾— v3.0.4 ä¿®æ­£ç‰ˆå›ºå®šç‰Œåº« (ç¬¦åˆ v2.1.0 è¦å‰‡)
        createFullDeck: () => {
            const data = {
                black: { n: [49, 64, 84, 90], p: 6 }, // 4å¼µ
                red: { n: [23, 26, 33, 44, 50, 54, 63, 70, 80], p: 4 }, // 9å¼µ
                blue: { n: [19, 22, 25, 27, 28, 32, 35, 42, 45, 48, 56, 60, 72], p: 2 }, // 13å¼µ
                yellow: { n: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 24, 30, 36, 40], p: 1 } // 22å¼µ
            };
            const decks = {};
            Object.keys(data).forEach(color => {
                decks[color] = app.shuffle([...data[color].n]).map(num => ({
                    number: num,
                    color: color,
                    points: data[color].p,
                    isTaken: false
                }));
            });
            return decks;
        },

        // v3.0.2: åŒæ™‚ç”¢ç”Ÿé‡‘å­—å¡”èˆ‡å‰©é¤˜ç‰Œåº«
        generateInitialGameData: () => {
            const decks = app.createFullDeck();
            const pyramid = new Array(10);
            
            // ä¾ç…§ v2.1.0 çµæ§‹å¡«å……ï¼š0(é»‘), 1-2(ç´…), 3-5(è—), 6-9(é»ƒ)
            // æ³¨æ„ï¼špop() æœƒå¾ç‰Œåº«ç§»é™¤è©²å¼µç‰Œï¼Œå‰©ä¸‹çš„å°±æ˜¯ remaining decks
            pyramid[0] = decks.black.pop();
            pyramid[1] = decks.red.pop(); pyramid[2] = decks.red.pop();
            pyramid[3] = decks.blue.pop(); pyramid[4] = decks.blue.pop(); pyramid[5] = decks.blue.pop();
            pyramid[6] = decks.yellow.pop(); pyramid[7] = decks.yellow.pop(); pyramid[8] = decks.yellow.pop(); pyramid[9] = decks.yellow.pop();
            
            return { pyramid, decks };
        },
        /* --- å›ºå®šç‰Œåº«èˆ‡é‡‘å­—å¡”é‚è¼¯çµæŸ --- */
    };

    // å•Ÿå‹•
    window.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>