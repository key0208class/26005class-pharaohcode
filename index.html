<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥æ®¿è©¦ç…‰ v3.2.9 - å››å‰‡é‚è¼¯ä¿®æ”¹ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5e6c8; /* [å¯ä¿®æ”¹] èƒŒæ™¯åº•è‰² */
            /* èƒŒæ™¯ç´‹ç† */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e6c677' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* 3D å¡ç‰‡ç¿»è½‰æ•ˆæœ */
        .pyramid-card { perspective: 1000px; width: 100%; height: 100%; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }
        
        /* éª°å­å‹•ç•« */
        .dice { transition: transform 0.5s ease-out; }
        .dice.rolling { animation: diceRoll 0.5s ease-in-out; }
        @keyframes diceRoll { 0%{transform:rotateX(0) rotateY(0) rotateZ(0)} 50%{transform:rotateX(720deg) rotateY(360deg) rotateZ(180deg)} 100%{transform:rotateX(0) rotateY(0) rotateZ(0)} }
        
        /* ç©å®¶ç•¶å‰ç‹€æ…‹èˆ‡å¡ç‰‡ç©ºä½ */
        .card-placeholder { border: 2px dashed #d4a85a; border-radius: 0.5rem; background-color: rgba(255,255,255,0.2); }
        .player-card { transition: all 0.3s ease; }
        .player-card:hover { transform: translateY(-3px); }
        .current-player { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5); border-color: #d97706; }
        
        /* äº’å‹•ç‹€æ…‹æ¨£å¼ */
        .selected-for-action { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.7); border: 2px solid #16a34a; transform: scale(1.02); }
        .selected-card-ring { box-shadow: 0 0 0 4px #ef4444; transform: scale(1.05); z-index: 10; }
        
        /* å€’æ•¸è¨ˆæ™‚ç·Šæ€¥ç‹€æ…‹å‹•ç•« (æ¼‚æµ® + æ”¾å¤§) */
        @keyframes urgentFloat { 0%, 100% { transform: translateY(0) scale(1.2); } 50% { transform: translateY(-5px) scale(1.3); } }
        .timer-urgent { animation: urgentFloat 1s ease-in-out infinite; color: #dc2626 !important; text-shadow: 2px 2px 0px #fff; }

        .edit-name-icon { cursor: pointer; user-select: none; margin-left: 8px; display: inline-block; opacity: 0.5; transition: opacity 0.2s; }
        .edit-name-icon:hover { opacity: 1; }
        
        .clickable-dice { cursor: pointer; transition: background-color 0.2s; }
        .clickable-dice:hover { background-color: #fceecb; transform: scale(1.05); }
        
        /* è¨Šæ¯çª—å¼·èª¿æ¨£å¼ */
        .message-highlight { color: #b45309; font-weight: 800; }
        
        /* Modal èƒŒæ™¯æ¨¡ç³Š */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 50; }
        
        /* v3.0 æ–°å¢æ¨£å¼ */
        .role-card { transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .role-card:hover { transform: translateY(-5px); border-color: #d97706; background-color: #fffbeb; }
        
        /* å¹³æ¿å„ªåŒ–ä½ˆå±€ */
        .tablet-layout { display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 1024px) {
            .tablet-layout { flex-direction: row; align-items: flex-start; }
            .tablet-left { width: 45%; flex-shrink: 0; }
            .tablet-right { width: 55%; flex-grow: 1; }
        }

        /* è¼¸å…¥æ¸¸æ¨™æ¨¡æ“¬ */
        .cursor-control-btn { touch-action: manipulation; }
        .cursor-control-btn:active { background-color: #d97706; transform: scale(0.95); }

        /* éš±è—åŸç”Ÿéµç›¤ä½†ä¿ç•™æ¸¸æ¨™ (é€é readonly é…åˆ JS) */
        .formula-input-readonly { caret-color: #d97706; cursor: text; }
        
        /* v3.2.9 æ–°å¢ï¼šè‡ªå‹•æ“²éª°é–‹é—œæ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #d97706; }
        input:focus + .slider { box-shadow: 0 0 1px #d97706; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* ç™»å…¥éå ´ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
/* --- v3.2.0 é“å…·ç³»çµ±æ¨£å¼ --- */
        .item-slot { position: relative; cursor: pointer; transition: all 0.2s; }
        .item-slot:hover { transform: scale(1.1); }
        .item-icon { font-size: 2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .item-count { position: absolute; bottom: -5px; right: -5px; background: #dc2626; color: white; font-size: 0.7rem; font-weight: bold; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .item-active { animation: pulse-gold 1.5s infinite; filter: drop-shadow(0 0 5px #fbbf24); }
        @keyframes pulse-gold { 0% { transform: scale(1); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 10px #fbbf24); } 100% { transform: scale(1); } }
        /* è€å¸«ç™¼æ”¾é“å…·æŒ‰éˆ• */
        .grant-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; transition: all 0.2s; }
        .grant-btn:hover { background-color: #fffbeb; border-color: #d97706; transform: translateY(-2px); }
        .grant-btn:active { transform: scale(0.95); }
        /* å­¸ç”Ÿçµ„åˆ¥æŒ‰éˆ• */
        .team-btn { transition: all 0.2s; }
        .team-btn.selected { ring: 4px; ring-color: #d97706; transform: scale(1.05); background-color: #fffbeb; }

        /* v3.0.5 æ–°å¢ï¼šæŒ‰éˆ•é–å®šç‹€æ…‹ */
        .btn-disabled { background-color: #9ca3af !important; background-image: none !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; opacity: 0.7; }
        
        /* v3.0.5 æ–°å¢ï¼šåŠ å¤§é‡‘å­—å¡”æ•¸å­—èˆ‡é‚Šæ¡† */
        .pyramid-num-lg { font-size: 2.5rem; line-height: 1; } 
        @media (min-width: 768px) { .pyramid-num-lg { font-size: 3.5rem; } }

        /* v3.0.8 æ–°å¢æ¨£å¼ */
        /* 1. æ¨¡æ“¬è¼¸å…¥æ¡†èˆ‡æ¸¸æ¨™ */
        .fake-input-container {
            min-height: 3.5rem;
            display: flex; align-items: center; justify-content: center;
            background-color: #f8fafc; border: 2px solid #c7d2fe; border-radius: 0.5rem;
            font-size: 1.5rem; font-weight: 700; letter-spacing: 0.1em;
            overflow-x: auto; white-space: nowrap; cursor: text;
        }
        .cursor-blink {
            display: inline-block; width: 2px; height: 1.5em; background-color: #d97706;
            margin: 0 2px; vertical-align: middle;
            animation: blink-animation 1s step-end infinite;
        }
        @keyframes blink-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 2. æ”¾å¤§ç‰Œåº«å‰©é¤˜é¡¯ç¤º */
        .deck-count-box { font-size: 1.1rem; padding: 0.5rem; }
        .deck-count-num { font-size: 1.5rem; font-weight: 900; margin-left: 4px; }

        /* 3. è€å¸«ä»‹é¢æ“´å…… (ä¸‰æ¬„ä½ˆå±€) */
        .teacher-panel-grid { display: grid; gap: 1rem; height: 100%; }
        @media (min-width: 1024px) {
            /* åœ¨å¤§è¢å¹•ä¸‹ï¼Œå·¦é‚Šæ§åˆ¶å°ï¼Œå³é‚Šæ’è¡Œæ¦œ */
            .teacher-panel-grid { grid-template-columns: 3fr 2fr; }
        }

        /* 4. å°çµ„è©³æƒ… Modal */
        .team-detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        
        /* 5. å­¸ç”Ÿåˆ†æ•¸é¢æ¿ */
        .student-score-pill { background: #fffbeb; border: 2px solid #fcd34d; color: #92400e; padding: 4px 12px; border-radius: 999px; font-weight: bold; font-size: 0.9rem; display: inline-flex; items-center; gap: 4px; box-shadow: 0 2px 0 rgba(217,119,6,0.2); }
		/* v3.0.9 æ–°å¢ï¼šé€šé—œç•«é¢èˆ‡æ’è¡Œæ¦œ */
        .game-over-modal-content {
            background: linear-gradient(135deg, #fffbeb 0%, #fff7ed 100%);
            border: 4px solid #b45309;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        
        .rank-badge { display: inline-flex; width: 2rem; height: 2rem; align-items: center; justify-content: center; border-radius: 50%; font-weight: 900; margin-right: 0.5rem; flex-shrink: 0; }
        .rank-1 { background: #fcd34d; color: #78350f; border: 2px solid #b45309; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .rank-2 { background: #e2e8f0; color: #475569; border: 2px solid #94a3b8; }
        .rank-3 { background: #ffedd5; color: #9a3412; border: 2px solid #c2410c; }
        .rank-other { background: #f3f4f6; color: #6b7280; font-size: 0.8rem; width: 1.5rem; height: 1.5rem; }
        
        .confetti-piece { position: absolute; width: 10px; height: 10px; background-color: #ffd700; animation: confetti-fall 3s linear infinite; }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen pb-12 text-slate-800">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-6 relative">
            <h1 class="text-3xl md:text-5xl font-black text-amber-800 mb-2 drop-shadow-sm tracking-wide">ğŸº ç¥æ®¿è©¦ç…‰ v3.2.9</h1>
            <p class="text-lg text-amber-700 font-medium">é€£ç·šç‰ˆ - å¤åŸƒåŠæ•¸å­¸è©¦ç…‰</p>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-mono text-gray-400">é€£ç·šä¸­...</div>
        </div>
        
        <div id="page-role-select" class="max-w-4xl mx-auto fade-in">
            <h2 class="text-2xl font-bold text-center mb-8 text-amber-900">è«‹é¸æ“‡ä½ çš„èº«ä»½</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="role-card bg-white rounded-3xl p-8 shadow-xl text-center" onclick="app.selectRole('teacher')">
                    <div class="text-6xl mb-4">ğŸ‘‘</div>
                    <h3 class="text-2xl font-bold text-amber-800 mb-2">æˆ‘æ˜¯æ³•è€ç‹ (è€å¸«)</h3>
                    <p class="text-slate-600">ä¸»æŒè©¦ç…‰ã€æŒæ§å‘½é‹éª°å­ã€æŸ¥çœ‹ç¥æ®¿å¤§å»³ã€‚</p>
                </div>
                <div class="role-card bg-white rounded-3xl p-8 shadow-xl text-center" onclick="app.selectRole('student')">
                    <div class="text-6xl mb-4">ğŸ¤ </div>
                    <h3 class="text-2xl font-bold text-amber-800 mb-2">æˆ‘æ˜¯å†’éšªè€… (å­¸ç”Ÿ)</h3>
                    <p class="text-slate-600">åŠ å…¥æ¢éšªéšŠã€ç ´è§£å¤è€åœ–é¨°ã€çˆ­å¥ªå¯¶è—ã€‚</p>
                </div>
            </div>
        </div>

        <div id="page-teacher-setup" class="hidden max-w-md mx-auto bg-amber-50 rounded-2xl p-8 shadow-xl border-4 border-amber-700 fade-in">
            <h2 class="text-2xl font-bold text-center mb-6 text-amber-900">ğŸ‘‘ æ³•è€ç‹ç™»åŸºå„€å¼</h2>
            <div class="mb-6">
                <label class="block text-amber-800 font-bold mb-2">è¨­å®šç­ç´šä»£ç¢¼ (Class ID)</label>
                <input type="text" id="setup-class-id" class="w-full p-4 border-2 border-amber-300 rounded-xl text-center text-2xl font-bold uppercase" placeholder="ä¾‹å¦‚: 501" maxlength="6">
            </div>
            <button onclick="app.createClass()" class="w-full bg-amber-800 hover:bg-amber-900 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-xl">å»ºç«‹æˆ¿é–“</button>
            <button onclick="app.backToRole()" class="mt-4 w-full text-amber-700 font-bold py-2">â¬…ï¸ è¿”å›</button>
        </div>

        <div id="page-student-login" class="hidden max-w-2xl mx-auto bg-amber-50 rounded-2xl p-8 shadow-xl border-4 border-amber-600 fade-in">
           <h2 class="text-2xl font-bold text-center mb-6 text-amber-900">ğŸ¤  åŠ å…¥æ¢éšªéšŠ</h2>
            
            <div id="login-step-1">
                <div class="mb-6">
                    <label class="block text-amber-800 font-bold mb-2">è¼¸å…¥ç­ç´šä»£ç¢¼</label>
                    <input type="text" id="login-class-id" class="w-full p-4 border-2 border-amber-300 rounded-xl text-center text-2xl font-bold uppercase" placeholder="è€å¸«çµ¦çš„ä»£ç¢¼">
                </div>
                <button onclick="app.checkClassExists()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg text-xl">ä¸‹ä¸€æ­¥ â¡ï¸</button>
            </div>

            <div id="login-step-2" class="hidden">
                <div class="mb-4">
                    <label class="block text-amber-800 font-bold mb-2">ä½ çš„å§“å (åº§è™Ÿ+åå­—)</label>
                    <input type="text" id="login-student-name" class="w-full p-3 border-2 border-amber-300 rounded-xl text-center text-xl" placeholder="ä¾‹: 25å°ç¿°">
                </div>
                <div class="mb-6">
                    <label class="block text-amber-800 font-bold mb-2">é¸æ“‡æ¢éšªå°çµ„</label>
                    <div id="team-select-container" class="grid grid-cols-3 gap-3">
                        </div>
                </div>
                <button onclick="app.joinGame()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg text-xl">ğŸš€ é–‹å§‹å†’éšª</button>
            </div>
            <button onclick="app.backToRole()" class="mt-4 w-full text-amber-700 font-bold py-2">â¬…ï¸ è¿”å›</button>
        </div>

        <div id="game-board" class="hidden fade-in">
            <div class="flex flex-wrap justify-between items-center mb-4 bg-white/80 backdrop-blur rounded-xl p-3 shadow border border-amber-200">
                <div class="flex items-center gap-3">
                    <span class="bg-amber-200 text-amber-900 px-3 py-1 rounded-full font-bold">ç­ç´š: <span id="display-class-id">--</span></span>
                    <span class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full font-bold" id="user-identity">--</span>
                </div>
                <div class="flex items-center gap-3 mt-2 md:mt-0">
                    <button id="voice-toggle-btn" class="hidden bg-gray-200 px-3 py-1 rounded-full text-sm font-bold" onclick="app.toggleVoice()">ğŸ”‡ èªéŸ³é—œ</button>
                    <button class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold border border-red-200" onclick="app.logout()">ğŸšª ç™»å‡º</button>
                </div>
            </div>

            <div class="tablet-layout">
                <div class="tablet-left flex flex-col gap-4">
                    <div class="bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300">
                        <div id="game-status-text" class="text-xl font-bold text-amber-800">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                        <div id="timer-display" class="hidden mt-2 text-4xl font-black text-red-600 font-mono drop-shadow-sm">30</div>
                    </div>

                    <div class="relative bg-amber-50/50 rounded-2xl p-4 min-h-[400px] flex flex-col items-center justify-center border-2 border-amber-200">
                        <div id="pyramid-board" class="w-full max-w-[320px] mx-auto scale-90 origin-top">
                            </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 text-center font-bold text-white mt-2">
                        <div class="bg-black/80 rounded-lg deck-count-box">é»‘<div class="deck-count-num" id="count-black">0</div></div>
                        <div class="bg-red-600 rounded-lg deck-count-box">ç´…<div class="deck-count-num" id="count-red">0</div></div>
                        <div class="bg-blue-600 rounded-lg deck-count-box">è—<div class="deck-count-num" id="count-blue">0</div></div>
                        <div class="bg-yellow-400 text-black rounded-lg deck-count-box">é»ƒ<div class="deck-count-num" id="count-yellow">0</div></div>
                    </div>
                </div>

               <div class="tablet-right flex flex-col h-full">
                    
                    <div id="panel-teacher" class="hidden bg-white rounded-2xl p-4 shadow-lg border-2 border-amber-600 h-full overflow-hidden">
                        <div class="teacher-panel-grid h-full">
                            <div class="flex flex-col h-full overflow-y-auto pr-1">
                                <h3 class="text-xl font-bold text-amber-900 mb-4 border-b pb-2 sticky top-0 bg-white z-10">ğŸ§™ æ³•è€ç‹è©¦ç…‰</h3>
                                
                                <div class="mb-4 p-3 bg-amber-50 rounded-xl border border-amber-200">
                                    <div class="flex justify-between items-center mb-2 px-1">
                                        <span class="text-xs font-bold text-amber-800 uppercase tracking-wider">Current Dice</span>
                                        <div class="flex items-center gap-2" title="é–‹å•Ÿå¾Œï¼ŒèªéŸ³æ’­å ±å®Œç•¢å°‡è‡ªå‹•æ“²éª°">
                                            <span class="text-xs font-bold text-amber-900">ğŸ¤– è‡ªå‹•æ“²éª°</span>
                                            <label class="switch">
                                                <input type="checkbox" id="auto-roll-toggle" onchange="app.toggleAutoRoll()">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="flex justify-center gap-2">
                                        <div id="t-dice-8" class="w-14 h-14 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-2xl font-black shadow">-</div>
                                        <div id="t-dice-10" class="w-14 h-14 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-2xl font-black shadow">-</div>
                                        <div id="t-dice-12" class="w-14 h-14 bg-white border-2 border-amber-400 rounded-lg flex items-center justify-center text-2xl font-black shadow">-</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <button id="btn-roll" onclick="app.teacherRollDice()" class="col-span-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white py-3 rounded-xl font-bold text-lg shadow hover:scale-105 transition-transform">ğŸ² æ“²éª°å­</button>
                                    <button onclick="app.teacherGetHint()" class="bg-indigo-600 text-white py-2 rounded-xl font-bold shadow hover:bg-indigo-700 text-sm">ğŸ”® æç¤º</button>
                                    <button onclick="app.forceNextRound()" class="bg-slate-600 text-white py-2 rounded-xl font-bold shadow hover:bg-slate-700 text-sm">ä¸‹ä¸€å±€</button>
                                    <button onclick="app.triggerEndGame()" class="col-span-2 bg-red-700 text-white py-2 rounded-xl font-bold shadow hover:bg-red-800 text-sm">ğŸ å†’éšªçµæŸ</button>
                                </div>

                                <div class="mt-2">
                                    <h4 class="font-bold text-amber-800 mb-2 flex justify-between items-center">
                                        <span>ğŸš© å†’éšªéšŠå¾—åˆ†</span>
                                        <span class="text-xs text-gray-500 font-normal">(é»æ“ŠéšŠåçœ‹è©³æƒ…)</span>
                                    </h4>
                                    <div id="teacher-team-board" class="space-y-2 text-sm"></div>
                                </div>
                            </div>

                            <div class="border-l pl-2 flex flex-col h-full overflow-hidden">
                                <h3 class="text-lg font-bold text-amber-900 mb-2 border-b pb-2 sticky top-0 bg-white z-10">ğŸ† å€‹äººè‹±é›„æ¦œ</h3>
                                <div id="teacher-personal-board" class="overflow-y-auto flex-1 pr-1 space-y-1 text-sm">
                                    </div>
                            </div>
                        </div>
                    </div>

                   <div id="panel-student" class="hidden flex flex-col h-full gap-3">
                        
                        <div id="student-inventory" class="hidden flex items-center justify-between bg-amber-100/50 p-2 rounded-lg border border-amber-200 mx-2">
                            <span class="text-xs font-bold text-amber-800 mr-2">ğŸ’ èƒŒåŒ…:</span>
                            <div id="inventory-list" class="flex gap-3 flex-1 justify-end"></div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-2 px-2 mb-2">
                            <div id="student-my-score-pill" class="student-score-pill w-full md:w-auto justify-center">ğŸ‘¤ è¼‰å…¥ä¸­...</div>
                            <div id="student-team-score-pill" class="student-score-pill w-full md:w-auto justify-center">ğŸš© è¼‰å…¥ä¸­...</div>
                        </div>

                        <div class="bg-white rounded-xl p-4 shadow border-2 border-amber-300">
                             <div class="flex justify-center gap-3 mb-3">
                                <button onclick="app.inputChar(app.state.dice.d8)" id="s-dice-8" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d10)" id="s-dice-10" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                                <button onclick="app.inputChar(app.state.dice.d12)" id="s-dice-12" class="cursor-control-btn w-12 h-12 bg-amber-100 border-2 border-amber-400 rounded-lg font-black text-xl hover:bg-amber-200 active:bg-amber-300 transition-colors">-</button>
                            </div>
                            
                            <div class="relative">
                                <div id="formula-display" class="fake-input-container" onclick="app.el('formula-display').focus()">
                                    <span class="text-gray-400 text-base font-normal">é»æ“ŠæŒ‰éˆ•è¼¸å…¥...</span>
                                </div>
                                <button onclick="app.backspace()" class="absolute right-2 top-2 bottom-2 px-3 text-red-500 hover:bg-red-50 rounded cursor-control-btn font-bold">âŒ«</button>
                            </div>
                        </div>
                            <div id="horus-input-area" class="hidden grid grid-cols-3 gap-2 mb-2 mt-2 animate-[fadeIn_0.3s_ease-out]"></div>
                        

                        <div id="active-item-status" class="hidden mb-2 p-3 rounded-lg border-2 border-amber-400 bg-amber-50 text-center animate-[popIn_0.3s_ease-out] cursor-pointer hover:bg-red-50 transition-colors" onclick="app.useItem(app.state.activeItem)" title="é»æ“Šå¯é—œé–‰é“å…·"></div>

                        <div class="grid grid-cols-4 gap-2 flex-grow">
                            <button onclick="app.inputChar('+')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">+</button>
                            <button onclick="app.inputChar('-')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">-</button>
                           <button onclick="app.inputChar('Ã—')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">Ã—</button>
                           <button onclick="app.inputChar('Ã·')" class="cursor-control-btn bg-indigo-100 text-indigo-900 rounded-lg font-bold text-2xl shadow border-b-4 border-indigo-200">Ã·</button>
                            
                            <button onclick="app.inputChar('(')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 col-span-2">(</button>
                            <button onclick="app.inputChar(')')" class="cursor-control-btn bg-indigo-50 text-indigo-800 rounded-lg font-bold text-xl shadow border-b-4 border-indigo-200 col-span-2">)</button>

                            <button onclick="app.moveCursor(-1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 col-span-2 active:bg-amber-300">â¬…ï¸</button>
                            <button onclick="app.moveCursor(1)" class="cursor-control-btn bg-amber-200 text-amber-900 rounded-lg font-black text-2xl shadow border-b-4 border-amber-300 col-span-2 active:bg-amber-300">â¡ï¸</button>

                            <button onclick="app.submitAnswer()" id="btn-submit" class="col-span-4 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg border-b-4 border-green-800 active:scale-95 active:border-b-0 transition-all mt-2 py-3 disabled:opacity-50 disabled:grayscale">âœ¨ é©—è­‰ç­”æ¡ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="msg-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-opacity opacity-0 pointer-events-none font-bold text-lg text-center w-max max-w-[90%]">
                æç¤ºè¨Šæ¯
            </div>
        </div>
        <div id="game-over-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop">
             <div class="game-over-modal-content bg-white rounded-3xl p-6 md:p-8 max-w-2xl w-full mx-4 relative overflow-hidden flex flex-col max-h-[90vh]">
                <div class="text-center mb-6 z-10">
                    <div class="text-5xl mb-2">ğŸ‰</div>
                    <h2 class="text-3xl md:text-4xl font-black text-amber-800 drop-shadow-sm">å¥ªå¯¶æˆåŠŸï¼</h2>
                    <p class="text-amber-600 font-bold mt-2">æ³•è€ç‹çš„è©¦ç…‰å·²çµæŸ</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 overflow-y-auto z-10 px-2 pb-2">
                    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                        <h3 class="font-bold text-amber-900 border-b border-amber-300 pb-2 mb-3 text-center text-lg">ğŸš© å†’éšªéšŠæ’å</h3>
                        <div id="end-team-ranks" class="space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-amber-200 shadow-inner">
                        <h3 class="font-bold text-amber-900 border-b border-amber-300 pb-2 mb-3 text-center text-lg">ğŸ† å‚³å¥‡å†’éšªå®¶</h3>
                        <div id="end-player-ranks" class="space-y-2"></div>
                    </div>
                </div>

                <div class="mt-6 text-center z-10 pt-4 border-t border-amber-100">
                    <p class="text-sm text-gray-500 mb-3">è€å¸«ç¢ºèªå¾Œå¯é–‹å•Ÿæ–°çš„ä¸€å±€</p>
                    <div class="flex flex-col md:flex-row justify-center gap-3">
                        <button id="btn-download-report" onclick="app.downloadGameData()" class="hidden bg-green-600 text-white px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-green-700 transition-transform">ğŸ“¥ ä¸‹è¼‰æˆ°ç¸¾è¡¨</button>
                        <button id="btn-restart-game" onclick="(async () => { try { await app.resetGame(); } catch(e) { console.error(e); } })()" class="hidden bg-gradient-to-r from-amber-600 to-amber-800 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg hover:scale-105 transition-transform">ğŸ”„ é–‹å•Ÿæ–°å†’éšª</button>
                    </div>
                    <button id="btn-close-end-modal" onclick="app.el('game-over-modal').classList.add('hidden')" class="md:hidden mt-2 text-gray-400 underline text-sm">æš«æ™‚é—œé–‰</button>
                </div>
             </div>
        </div>

        <div id="team-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')">
             <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border-4 border-amber-600 animate-[fadeIn_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-black text-amber-900" id="modal-team-title">å°çµ„è©³æƒ…</h3>
                    <button onclick="document.getElementById('team-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
                </div>
                <div id="modal-team-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                    </div>
             </div>
        </div>
        <div id="solution-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
             <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl border-4 border-amber-600 text-center animate-[urgentFloat_0.5s_ease-out]">
                <h3 class="text-2xl font-black text-amber-900 mb-4">ğŸ”® æ³•è€ç‹çš„æç¤º</h3>
                <div class="bg-amber-100 p-4 rounded-xl mb-4">
                    <p class="text-sm text-amber-800 mb-1">å‰å…©å€‹æ•¸å­—çš„é‹ç®—æ˜¯...</p>
                    <p id="solution-hint-text" class="text-3xl font-bold text-indigo-700 font-mono tracking-wider">--</p>
                </div>
                <button onclick="document.getElementById('solution-modal').classList.add('hidden')" class="bg-amber-700 text-white px-6 py-2 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
             </div>
        </div>
<div id="reset-overlay" class="fixed inset-0 z-[70] hidden flex flex-col items-center justify-center bg-slate-900/95 text-white animate-[fadeIn_0.5s_ease-out]">
            <div class="text-6xl mb-6 animate-bounce">ğŸº</div>
            <h2 class="text-3xl md:text-5xl font-black mb-4 text-amber-400 tracking-widest">å†’éšªå·²é‡ç½®</h2>
            <p class="text-xl text-gray-300 mb-12">æ³•è€ç‹å·²é–‹å•Ÿæ–°çš„ç¯‡ç« </p>
            <button onclick="app.logout()" class="group relative px-8 py-4 bg-transparent overflow-hidden rounded-full transition-all hover:scale-105">
                <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-amber-500 to-amber-700 opacity-90 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center gap-3">
                    <span class="text-2xl font-bold text-white shadow-sm">ğŸ”™ å›åˆ°åˆå§‹ä¹‹åœ°</span>
                </div>
            </button>
        </div>
    </div>
	<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyDPGUqIx8qWEmKDPaI5Pwnm6nSJ95KjpHg",
        authDomain: "pharaoh-code-v3.firebaseapp.com",
        projectId: "pharaoh-code-v3",
        databaseURL: "https://pharaoh-code-v3-default-rtdb.asia-southeast1.firebasedatabase.app",
        storageBucket: "pharaoh-code-v3.firebasestorage.app",
        messagingSenderId: "884553648676",
        appId: "1:884553648676:web:a30ca4b251a6f4f6da66b1"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯ ---
    const app = {
        state: {
            role: null, 
            classId: null,
            myTeam: null,
            myName: null,
            gameData: {},
            cards: {}, 
            voiceEnabled: true, // v3.2.4 ä¿®æ”¹ï¼šé è¨­é–‹å•ŸèªéŸ³
            localTimer: null,
            selectedCardIndex: null,
            // v3.0.8 æ–°å¢: è¼¸å…¥ç‹€æ…‹ç®¡ç†
            inputFormula: "", 
            inputCursorPos: 0,
            lastRoundProcessed: 0,
            lastStatus: null, // v3.2.4 æ–°å¢ï¼šç”¨æ–¼åµæ¸¬ç‹€æ…‹æ”¹è®Šä»¥è§¸ç™¼èªéŸ³
            lastWinnerTime: 0, // v3.2.6 æ–°å¢ï¼šç”¨æ–¼åˆ¤æ–·æ˜¯å¦æ’­æ”¾éå»£æ’­
            autoRollEnabled: false, // v3.2.9 æ–°å¢ï¼šè‡ªå‹•æ“²éª°é–‹é—œ
            isResetting: false // v3.1.2 æ–°å¢ï¼šé˜²æ­¢è€å¸«é‡ç½®æ™‚è‡ªæˆ‘ç™»å‡º
        },

        el: (id) => document.getElementById(id),

        // v3.2.9 æ–°å¢ï¼šè‡ªå‹•æ“²éª°æ§åˆ¶
        toggleAutoRoll: () => {
            app.state.autoRollEnabled = app.el('auto-roll-toggle').checked;
            const msg = app.state.autoRollEnabled ? 'ğŸ¤– è‡ªå‹•æ“²éª°å·²é–‹å•Ÿ' : 'ğŸ›‘ è‡ªå‹•æ“²éª°å·²é—œé–‰';
            app.toast(msg);
            // å¦‚æœé–‹å•Ÿç•¶ä¸‹æ­£å¥½æ˜¯ç­‰å¾…ç‹€æ…‹ï¼Œå˜—è©¦è§¸ç™¼
            if (app.state.autoRollEnabled && app.state.gameData.status === 'waiting') {
                app.triggerAutoRollQueue();
            }
        },

        triggerAutoRollQueue: () => {
            // å®‰å…¨æª¢æŸ¥ï¼šè‹¥æœªé–‹å•Ÿã€éç­‰å¾…ç‹€æ…‹ï¼Œå‰‡å–æ¶ˆ
            if (!app.state.autoRollEnabled || app.state.gameData?.status !== 'waiting') return;

            // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¬›è©± (ä¾‹å¦‚ã€Œæ™‚é–“åˆ°...ã€)
            if (window.speechSynthesis.speaking) {
                // è‹¥æ­£åœ¨è¬›è©±ï¼Œæ¯ 1 ç§’æª¢æŸ¥ä¸€æ¬¡
                setTimeout(app.triggerAutoRollQueue, 1000);
            } else {
                // èªéŸ³çµæŸï¼Œå»¶é² 1 ç§’å¾Œæ“²éª° (é¿å…å¤ªå¿«è®“äººåæ‡‰ä¸éä¾†)
                setTimeout(() => {
                    // å†æ¬¡ç¢ºèªç‹€æ…‹ï¼Œé¿å…åœ¨å€’æ•¸æ™‚è§¸ç™¼
                    if (app.state.autoRollEnabled && app.state.gameData?.status === 'waiting') {
                        app.teacherRollDice();
                    }
                }, 1000);
            }
        },

        // --- 1. åˆå§‹åŒ–èˆ‡è‡ªå‹•ç™»å…¥ ---
        init: () => {
            app.createPredefinedCards();
            // v3.0.8: è‡ªå‹•é‡é€£æ©Ÿåˆ¶
            const savedState = localStorage.getItem('pharaoh_v3_state');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                // ç°¡å–®é©—è­‰è³‡æ–™å®Œæ•´æ€§
                if (parsed.classId && parsed.role) {
                    console.log('ğŸ”„ åµæ¸¬åˆ°æ–·ç·šé‡é€£...', parsed);
                    app.state.classId = parsed.classId;
                    app.state.role = parsed.role;
                    app.state.myTeam = parsed.team; // è€å¸«æ­¤é …å¯èƒ½ç‚º null
                    app.state.myName = parsed.name; // è€å¸«æ­¤é …å¯èƒ½ç‚º null
                    
                    // æ¢å¾©ä»‹é¢
                    app.el('page-role-select').classList.add('hidden');
                    app.startGameInterface();
                    app.toast('ğŸ”„ å·²è‡ªå‹•æ¢å¾©é€£ç·š');
                }
            }
        },

        // --- 2. è§’è‰²èˆ‡ç™»å…¥æµç¨‹ ---
        selectRole: (role) => {
            app.state.role = role;
            app.el('page-role-select').classList.add('hidden');
            if (role === 'teacher') {
                app.el('page-teacher-setup').classList.remove('hidden');
            } else {
                app.el('page-student-login').classList.remove('hidden');
                app.el('login-step-1').classList.remove('hidden');
            }
        },

        backToRole: () => {
            app.el('page-teacher-setup').classList.add('hidden');
            app.el('page-student-login').classList.add('hidden');
            app.el('page-role-select').classList.remove('hidden');
            app.state.role = null;
            localStorage.removeItem('pharaoh_v3_state'); // æ¸…é™¤å¿«å–
        },

        createClass: () => {
            const classId = app.el('setup-class-id').value.trim();
            if (!classId) return app.toast('âŒ è«‹è¼¸å…¥ç­ç´šä»£ç¢¼');
            
            app.state.classId = classId;
            app.saveLocalState(); // å„²å­˜ç‹€æ…‹

            const classRef = db.ref(`classes/${classId}`);
            const initialData = app.generateInitialGameData();

            classRef.set({
                status: 'waiting', 
                dice: { d8: '-', d10: '-', d12: '-' },
                round: 1,
                timer: 30,
                timerActive: false,
                pyramid: initialData.pyramid,
                decks: initialData.decks,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                app.startGameInterface();
            });
        },

        checkClassExists: () => {
            const classId = app.el('login-class-id').value.trim();
            if (!classId) return app.toast('âŒ è«‹è¼¸å…¥ç­ç´šä»£ç¢¼');

            db.ref(`classes/${classId}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    app.state.classId = classId;
                    app.el('login-step-1').classList.add('hidden');
                    app.el('login-step-2').classList.remove('hidden');
                    app.renderTeamButtons();
                } else {
                    app.toast('âŒ æ‰¾ä¸åˆ°æ­¤ç­ç´šï¼Œè«‹ç¢ºèªä»£ç¢¼');
                }
            });
        },

        renderTeamButtons: () => {
            const container = app.el('team-select-container');
            const teams = [
                {id: 1, name: 'ç¬¬1çµ„:é˜¿åŠªæ¯”æ–¯', icon: 'ğŸ•'},
                {id: 2, name: 'ç¬¬2çµ„:è·é­¯æ–¯', icon: 'ğŸ¦…'},
                {id: 3, name: 'ç¬¬3çµ„:å·´æ–¯æ³°ç‰¹', icon: 'ğŸ±'},
                {id: 4, name: 'ç¬¬4çµ„:æ­è¥¿é‡Œæ–¯', icon: 'ğŸ§Ÿ'},
                {id: 5, name: 'ç¬¬5çµ„:ä¼Šè¥¿æ–¯', icon: 'ğŸ¦‹'},
                {id: 6, name: 'ç¬¬6çµ„:å¤ªé™½ç¥æ‹‰', icon: 'ğŸŒ'}
            ];
            let html = '';
            teams.forEach(t => {
                html += `<button onclick="app.selectTeam(${t.id}, this)" class="team-btn bg-white border-2 border-amber-300 text-amber-900 font-bold py-3 rounded-lg hover:bg-amber-50 flex flex-col items-center justify-center text-sm"><span>${t.icon}</span><span>${t.name}</span></button>`;
            });
            container.innerHTML = html;
        },

        selectTeam: (teamId, btnElement) => {
            app.state.myTeam = `team${teamId}`;
            document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('selected', 'bg-amber-100', 'border-amber-600'));
            btnElement.classList.add('selected', 'bg-amber-100', 'border-amber-600');
        },

        joinGame: () => {
            const name = app.el('login-student-name').value.trim();
            if (!name) return app.toast('âŒ è«‹è¼¸å…¥å§“å (åº§è™Ÿ+åå­—)');
            if (!app.state.myTeam) return app.toast('âŒ è«‹é¸æ“‡æ¢éšªå°çµ„');

            app.state.myName = name;
            app.saveLocalState(); // å„²å­˜ç‹€æ…‹

            const playerRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${name}`);
            playerRef.update({
                name: name,
                score: 0,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });

            app.startGameInterface();
        },

        // v3.0.8: å„²å­˜ç™»å…¥ç‹€æ…‹åˆ° LocalStorage
        saveLocalState: () => {
            const data = {
                role: app.state.role,
                classId: app.state.classId,
                team: app.state.myTeam,
                name: app.state.myName
            };
            localStorage.setItem('pharaoh_v3_state', JSON.stringify(data));
        },

        // --- 3. éŠæˆ²ä»‹é¢èˆ‡åŒæ­¥ ---
        startGameInterface: () => {
            app.el('page-teacher-setup').classList.add('hidden');
            app.el('page-student-login').classList.add('hidden');
            app.el('game-board').classList.remove('hidden');
            
            app.el('display-class-id').textContent = app.state.classId;
            app.el('user-identity').textContent = app.state.role === 'teacher' ? 'ğŸ‘‘ è€å¸«' : `ğŸ¤  ${app.state.myName}`;

            if (app.state.role === 'teacher') {
                app.el('panel-teacher').classList.remove('hidden');
                app.el('voice-toggle-btn').classList.remove('hidden');
            } else {
                app.el('panel-student').classList.remove('hidden');
            }

            app.listenToGameData();
            if (app.state.role === 'teacher') {
                setInterval(() => {
                    if (app.state.gameData && app.state.gameData.timerActive && app.state.gameData.timer > 0) {
                        const newTime = app.state.gameData.timer - 1;
                        db.ref(`classes/${app.state.classId}/timer`).set(newTime);
                        
                        if (newTime <= 10 && newTime > 0) app.speak(newTime.toString());
                        if (newTime === 0) {
                            app.handleTimeUp();
                            db.ref(`classes/${app.state.classId}/timerActive`).set(false);
                        }
                    }
                }, 1000);
            }
        },

      listenToGameData: () => {
            const classRef = db.ref(`classes/${app.state.classId}`);
            
            classRef.on('value', snapshot => {
                const data = snapshot.val();
                
                // [v3.1.5] ä¿®æ­£ï¼šåµæ¸¬åˆ°æˆ¿é–“è¢«é‡ç½® -> é¡¯ç¤ºã€Œå›åˆ°åˆå§‹ä¹‹åœ°ã€é®ç½©
                if (!data || data.status === 'restarting' || data.status === 'reset_completed') {
                    // éš±è—éŠæˆ²ä»‹é¢ï¼Œé¡¯ç¤ºé‡ç½®é®ç½©
                    app.el('game-board').classList.add('hidden');
                    app.el('game-over-modal').classList.add('hidden');
                    app.el('reset-overlay').classList.remove('hidden');
                    
                    // å¦‚æœæˆ‘æ˜¯æ­£åœ¨æ“ä½œé‡ç½®çš„è€å¸«ï¼Œå°±ä¸è·³å‡º Toast äº†
                    if (!app.state.isResetting) {
                        // é€™è£¡ä¸è‡ªå‹• logoutï¼Œè€Œæ˜¯ç­‰å¾…ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•
                    }
                    return;
                }

                // [v3.0.8] åµæ¸¬å›åˆåˆ‡æ›,æ¸…ç©ºè¼¸å…¥
                // [v3.0.8] åµæ¸¬å›åˆåˆ‡æ›
                if (data.round && data.round > app.state.lastRoundProcessed) {
                    app.state.lastRoundProcessed = data.round;
                    if (app.state.role === 'student') {
                        app.resetInput();
                        // v3.3.1: æ–°å›åˆå¼·åˆ¶æ¸…é™¤æ‰€æœ‰é“å…·æ•ˆæœ (åŒ…å«å°¼ç¾…æ²³)
                        app.state.activeItem = null;
                        // é‡æ–°æ¸²æŸ“é“å…·åˆ—ä»¥ç§»é™¤ç‹€æ…‹æ¡†
                        app.renderStudentInventory(data.players); 
                        app.toast('ğŸ”” æ–°å›åˆé–‹å§‹ï¼Œé“å…·æ•ˆæœå·²é‡ç½®');
                    }
                }

                // v3.2.6 æ–°å¢ï¼šè€å¸«ç«¯ç›£è½è´å®¶ä¸¦å»£æ’­
                if (app.state.role === 'teacher' && data.lastWinner && data.lastWinner.timestamp > app.state.lastWinnerTime) {
                    // æ›´æ–°æœ¬åœ°ç´€éŒ„çš„æ™‚é–“ï¼Œé¿å…é‡è¤‡æ’­æ”¾
                    app.state.lastWinnerTime = data.lastWinner.timestamp;
                    
                    // åªæœ‰ç•¶é€™å€‹è¨Šæ¯æ˜¯ã€Œæ–°çš„ã€ï¼ˆä¾‹å¦‚ç¾åœ¨ç™¼ç”Ÿçš„ï¼Œè€Œä¸æ˜¯å‰›ç™»å…¥æ™‚è¼‰å…¥çš„èˆŠç´€éŒ„ï¼‰æ‰æ’­æ”¾
                    // é€™è£¡åšä¸€å€‹ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœè·é›¢ç¾åœ¨è¶…é 10 ç§’çš„èˆŠè³‡æ–™å°±ä¸å¿µäº†ï¼ˆé¿å…é‡æ•´é é¢æ™‚ç‹‚å¿µï¼‰
                    const now = Date.now();
                    // æ³¨æ„: firebase timestamp æ˜¯ä¼ºæœå™¨æ™‚é–“ï¼Œèˆ‡æœ¬åœ°å¯èƒ½æœ‰èª¤å·®ï¼Œä½†é€šå¸¸ä¸æœƒå·®å¤ªå¤š
                    // å¦‚æœ timestamp æ˜¯ä¸€å€‹å¾ˆå¤§çš„æ•¸å­—æ‰æª¢æŸ¥
                    if (now - data.lastWinner.timestamp < 10000) {
                         app.speak(`æ­å–œ${data.lastWinner.name}å¥ªå¯¶æˆåŠŸï¼`);
                         app.toast(`ğŸ‰ æ­å–œ ${data.lastWinner.name} å¥ªå¯¶æˆåŠŸï¼`);
                    }
                }

                app.state.gameData = data;
                app.updateUI(data);
            });
        },

       updateUI: (data) => {
            const statusEl = app.el('game-status-text');
            const statusBox = statusEl.parentElement;
            
            // v3.2.4 å„ªåŒ–ï¼šç‹€æ…‹æ”¹è®Šæ™‚çš„åŒæ­¥èªéŸ³èˆ‡æç¤ºé‚è¼¯
           // v3.2.4 å„ªåŒ–ï¼šç‹€æ…‹æ”¹è®Šæ™‚çš„åŒæ­¥èªéŸ³èˆ‡æç¤ºé‚è¼¯
            if (app.state.lastStatus !== data.status) {
                // v3.2.9 æ–°å¢ï¼šåµæ¸¬è½‰ç‚ºç­‰å¾…ç‹€æ…‹æ™‚ï¼Œè§¸ç™¼è‡ªå‹•æ“²éª°
                if (data.status === 'waiting' && app.state.lastStatus !== 'waiting' && app.state.autoRollEnabled) {
                    app.triggerAutoRollQueue();
                }

                app.state.lastStatus = data.status;
                if (data.status === 'dead_end') {
                    const msg = "âš ï¸ æ­¤å±€ç„¡è§£ï¼4ç§’å¾Œé‡æ–°é–‹å§‹...";
                    app.toast(msg);
                    // ç¢ºä¿èªéŸ³ä¸é‡è¤‡è§¸ç™¼
                }
            }

            statusBox.className = "bg-amber-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-amber-300 transition-colors duration-300";
            statusEl.className = "text-xl font-bold text-amber-800";
            
            const statusMap = {
                'waiting': 'ç­‰å¾…æ³•è€ç‹é–‹å•Ÿè©¦ç…‰...',
                'rolling': 'ğŸ² å‘½é‹ä¹‹éª°è½‰å‹•ä¸­...',
                'playing': 'âœ¨ è©¦ç…‰é€²è¡Œä¸­ - ç ´è§£åœ–é¨°ï¼',
                'dead_end': 'âš ï¸ æ­¤å±€ç„¡è§£ï¼æº–å‚™é‡æ–°é–‹å§‹...', // v3.2.4 æ–°å¢ç‹€æ…‹
                'ended': 'ğŸ å†’éšªçµæŸ - çµ±è¨ˆæˆ°æœ'
            };
            statusEl.textContent = statusMap[data.status] || data.status;

            // ç‰¹æ®Šç‹€æ…‹æ¨£å¼
            if (data.status === 'dead_end') {
                statusBox.className = "bg-red-100 rounded-2xl p-4 shadow-inner text-center relative border-2 border-red-400 animate-pulse";
                statusEl.className = "text-xl font-black text-red-800";
            }

            app.updateDiceUI(data.dice);
            app.renderPyramid(data.pyramid);

            if (data.timerActive) {
                app.el('timer-display').classList.remove('hidden');
                app.el('timer-display').textContent = data.timer;
                if(data.timer === 0) app.handleTimeUp(); 
            } else {
                app.el('timer-display').classList.add('hidden');
            }
            
            app.calculateAndRenderScores(data.players);
            // v3.2.0: æ›´æ–°å­¸ç”ŸèƒŒåŒ…é¡¯ç¤º
            if (app.state.role === 'student') {
                app.renderStudentInventory(data.players);
            }
            // v3.0.9: éŠæˆ²çµæŸæ™‚ï¼Œè‡ªå‹•å½ˆå‡ºçµç®—ç•«é¢
            if (data.status === 'ended') {
                app.renderGameOverStats(data.players);
                app.el('game-over-modal').classList.remove('hidden');
                
                // [v3.1.0] åªæœ‰è€å¸«èƒ½çœ‹åˆ°ã€Œä¸‹è¼‰ã€èˆ‡ã€Œé‡å•Ÿã€æŒ‰éˆ•
                if (app.state.role === 'teacher') {
                    app.el('btn-restart-game').classList.remove('hidden');
                    app.el('btn-download-report').classList.remove('hidden'); // é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
                }
            } else {
                app.el('game-over-modal').classList.add('hidden');
            }

            // è€å¸«ç«¯é‚è¼¯
            if (app.state.role === 'teacher') {
                const btnRoll = app.el('btn-roll');
                // çµæŸæ™‚é–å®šæ“²éª°
                if (data.status === 'waiting') {
                    btnRoll.disabled = false;
                    btnRoll.classList.remove('btn-disabled');
                    btnRoll.textContent = "ğŸ² æ“²éª°å­";
                } else {
                    btnRoll.disabled = true;
                    btnRoll.classList.add('btn-disabled');
                    btnRoll.textContent = (data.status === 'ended') ? "ğŸ çµ±è¨ˆä¸­" : ((data.status === 'rolling') ? "ğŸ² è½‰å‹•ä¸­..." : "ğŸ”’ é–å®šä¸­");
                }
                
                // æ­»å±€æª¢æŸ¥ (åƒ…åœ¨éŠç©ä¸­ä¸”éå€’æ•¸ç‹€æ…‹)
                if (data.status === 'playing') {
                    const currentDice = [data.dice.d8, data.dice.d10, data.dice.d12];
                    const remainingTargets = data.pyramid
                        .filter(c => c && !c.isTaken)
                        .map(c => c.number);
                    
                    if (remainingTargets.length > 0) {
                        let hasSolution = false;
                        for (let target of remainingTargets) {
                            if (app.findSolution(currentDice, target)) {
                                hasSolution = true;
                                break;
                            }
                        }
                        if (!hasSolution) {
                            // v3.2.5 ä¿®æ­£ï¼šéŠæˆ²ä¸­é€”è®Šç„¡è§£ï¼Œç›´æ¥å¯«å…¥è³‡æ–™åº«ï¼Œè§¸ç™¼å…¨é«”å»£æ’­èˆ‡å€’æ•¸
                            // åŠ ä¸Šé˜²æ­¢é‡è¤‡è§¸ç™¼çš„é–ï¼šåªæœ‰åœ¨ç‹€æ…‹å°šæœªè®Šæˆ dead_end æ™‚æ‰åŸ·è¡Œ
                            if (app.state.lastStatus !== 'dead_end') {
                                db.ref(`classes/${app.state.classId}`).update({
                                    status: 'dead_end',
                                    timerActive: false // åœæ­¢åŸæœ¬çš„å€’æ•¸(å¦‚æœæœ‰)
                                });
                                // è€å¸«ç«¯è² è²¬åœ¨ 4 ç§’å¾Œå¼·åˆ¶æ›å±€
                                setTimeout(() => app.forceNextRound(), 4000);
                            }
                        }
                    }
                }
            }
        },

        // v3.0.9: ä¿®æ­£å¾Œçš„è¨ˆåˆ†èˆ‡é¡¯ç¤ºé‚è¼¯
        calculateAndRenderScores: (players) => {
            if (!players) return;

            const teamStats = {}; 
            let allPlayers = [];

            for(let i=1; i<=6; i++) {
                const teamKey = `team${i}`;
                teamStats[teamKey] = {
                    key: teamKey,
                    name: app.getTeamName(teamKey),
                    shortName: app.getTeamShortName(teamKey), // v3.0.9
                    score: 0,
                    count: 0,
                    members: []
                };
            }

            Object.keys(players).forEach(teamKey => {
                if(teamStats[teamKey]) {
                    const membersObj = players[teamKey];
                    Object.values(membersObj).forEach(p => {
                        teamStats[teamKey].score += (p.score || 0);
                        teamStats[teamKey].count += 1;
                        teamStats[teamKey].members.push(p);
                        allPlayers.push({...p, team: teamKey});
                    });
                }
            });

            // v3.0.9: å­¸ç”Ÿç«¯é¡¯ç¤ºå„ªåŒ– - é¡¯ç¤ºåå­—èˆ‡å®Œæ•´çµ„å
            if (app.state.role === 'student' && app.state.myTeam && app.state.myName) {
                const myTeamData = players[app.state.myTeam];
                const myData = myTeamData ? myTeamData[app.state.myName] : null;
                const myScore = myData ? (myData.score || 0) : 0;
                
                app.el('student-my-score-pill').textContent = `ğŸ‘¤ ${app.state.myName} å¾—åˆ†: ${myScore}`;
                app.el('student-team-score-pill').textContent = `ğŸš© ${teamStats[app.state.myTeam].name} å¾—åˆ†: ${teamStats[app.state.myTeam].score}`;
            }

            // è€å¸«ç«¯æ¸²æŸ“
            if (app.state.role === 'teacher') {
                let teamHtml = '';
                for(let i=1; i<=6; i++) {
                    const t = teamStats[`team${i}`];
                    teamHtml += `<div onclick="app.showTeamModal('${t.key}')" class="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-200 cursor-pointer hover:bg-amber-100 transition-colors"><div class="flex items-center gap-2"><span class="font-bold text-gray-700">${t.name}</span><span class="text-xs bg-gray-200 text-gray-600 px-1 rounded">${t.count}äºº</span></div><span class="font-black text-amber-700 text-lg">${t.score}</span></div>`;
                }
                app.el('teacher-team-board').innerHTML = teamHtml;

                allPlayers.sort((a, b) => b.score - a.score);
                let personalHtml = '';
                allPlayers.forEach((p, index) => {
                    const rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : ''));
                    const highlight = (index < 3) ? 'bg-yellow-50 border-yellow-200' : 'bg-white border-slate-100';
                    personalHtml += `<div class="flex justify-between items-center p-2 ${highlight} rounded border mb-1"><div class="truncate mr-2"><span class="font-bold mr-1 text-sm">${index+1}.</span>${p.name} <span class="text-xs text-gray-400">(${app.getTeamShortName(p.team)})</span></div><div class="font-bold text-amber-700 flex-shrink-0">${p.score}${rankIcon}</div></div>`;
                });
                if(allPlayers.length === 0) personalHtml = '<div class="text-center text-gray-400 py-4 text-xs">æš«ç„¡å†’éšªè€…åŠ å…¥</div>';
                app.el('teacher-personal-board').innerHTML = personalHtml;
                
                app.state.latestTeamStats = teamStats;
            }
        },

        // v3.0.9: ç”¢ç”ŸéŠæˆ²çµæŸçš„çµç®—ç•«é¢å…§å®¹
        renderGameOverStats: (players) => {
            if (!players) return;
            
            // 1. è¨ˆç®—å°çµ„æ’å
            const teams = [];
            for(let i=1; i<=6; i++) {
                const key = `team${i}`;
                if(players[key]) {
                    let score = 0;
                    Object.values(players[key]).forEach(p => score += (p.score||0));
                    teams.push({ name: app.getTeamName(key), score: score });
                } else {
                    teams.push({ name: app.getTeamName(key), score: 0 });
                }
            }
            teams.sort((a, b) => b.score - a.score);
            
            let teamHtml = '';
            teams.forEach((t, i) => {
                const rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : 'rank-other'));
                teamHtml += `<div class="flex items-center justify-between p-2 rounded bg-white border border-gray-100"><div class="flex items-center"><span class="rank-badge ${rankClass}">${i+1}</span><span class="font-bold text-gray-700">${t.name}</span></div><span class="font-black text-amber-700">${t.score}åˆ†</span></div>`;
            });
            app.el('end-team-ranks').innerHTML = teamHtml;

            // 2. è¨ˆç®—å€‹äºº MVP (å‰ 3-5 å)
            let allPlayers = [];
            Object.keys(players).forEach(teamKey => {
                Object.values(players[teamKey]).forEach(p => {
                    allPlayers.push({...p, teamName: app.getTeamShortName(teamKey)});
                });
            });
            allPlayers.sort((a, b) => b.score - a.score);
            
            let playerHtml = '';
            allPlayers.slice(0, 5).forEach((p, i) => {
                const rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : 'rank-other'));
                playerHtml += `<div class="flex items-center justify-between p-2 rounded bg-slate-50 border border-slate-100"><div class="flex items-center"><span class="rank-badge ${rankClass}">${i+1}</span><div><div class="font-bold text-gray-800">${p.name}</div><div class="text-xs text-gray-500">${p.teamName}</div></div></div><span class="font-black text-amber-700">${p.score}åˆ†</span></div>`;
            });
            if(allPlayers.length === 0) playerHtml = '<div class="text-center text-gray-400">ç„¡æ•¸æ“š</div>';
            app.el('end-player-ranks').innerHTML = playerHtml;
        },

    showTeamModal: (teamKey) => {
            if (!app.state.latestTeamStats) return;
            const team = app.state.latestTeamStats[teamKey];
            if (!team) return;

            app.el('modal-team-title').textContent = `${team.name} (${team.count}äºº)`;
            const listEl = app.el('modal-team-list');
            
            // æ’åºçµ„å“¡åˆ†æ•¸
            team.members.sort((a, b) => b.score - a.score);
            
            // v3.3.0 ä¿®æ”¹ï¼šæ“´å……é“å…·ç™¼æ”¾é¢æ¿ (å››ç¨®é“å…·)
            // ç‚ºäº†é¿å…ç©ºç™½ç¯€é»ï¼ŒHTML å­—ä¸²æ¡ç·Šæ¹Šå¯«æ³•
            let html = '<div class="mb-4 bg-amber-50 p-3 rounded-xl border border-amber-200"><div class="grid grid-cols-2 gap-2 mb-2">';
            html += `<button onclick="app.grantItem('${teamKey}', 'hint')" class="grant-btn"><span class="text-2xl mb-1">ğŸ“œ</span><span class="text-xs font-bold text-amber-900">æç¤ºå¡</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'double')" class="grant-btn"><span class="text-2xl mb-1">ğŸ¦‚</span><span class="text-xs font-bold text-amber-900">è–ç”²èŸ²</span></button>`;
            html += '</div><div class="grid grid-cols-2 gap-2">';
            html += `<button onclick="app.grantItem('${teamKey}', 'horus')" class="grant-btn"><span class="text-2xl mb-1">ğŸ‘ï¸</span><span class="text-xs font-bold text-amber-900">è·é­¯æ–¯ä¹‹çœ¼</span></button>`;
            html += `<button onclick="app.grantItem('${teamKey}', 'nile')" class="grant-btn"><span class="text-2xl mb-1">ğŸŒŠ</span><span class="text-xs font-bold text-amber-900">å°¼ç¾…æ²³æ©è³œ</span></button>`;
            html += '</div></div><div class="text-xs text-gray-500 mb-2 font-bold">çµ„å“¡åˆ—è¡¨ï¼š</div>';

            team.members.forEach(m => {
                let itemsBadge = '';
                if (m.items) {
                    if (m.items.hint) itemsBadge += 'ğŸ“œ';
                    if (m.items.double) itemsBadge += 'ğŸ¦‚';
                    if (m.items.horus) itemsBadge += 'ğŸ‘ï¸';
                    if (m.items.nile) itemsBadge += 'ğŸŒŠ';
                }
                html += `<div class="team-detail-row items-center"><span class="font-bold text-gray-700">${m.name} <span class="text-xs">${itemsBadge}</span></span><span class="font-bold text-amber-600">${m.score}åˆ†</span></div>`;
            });
            
            if (team.members.length === 0) html += '<div class="text-center text-gray-400 py-4">ç›®å‰æ²’æœ‰çµ„å“¡</div>';
            
            listEl.innerHTML = html;
            app.el('team-modal').classList.remove('hidden');
        },

        // v3.2.0 æ–°å¢ï¼šç™¼æ”¾é“å…·é‚è¼¯
      // [ä¿®æ”¹ 2] æ¬Šé‡å‹é“å…·ç™¼é€ï¼šåˆ†æ•¸ä½ã€é“å…·å°‘è€…å„ªå…ˆ
        grantItem: (teamKey, type) => {
             const team = app.state.latestTeamStats[teamKey];
             if (!team || team.members.length === 0) return app.toast('âŒ è©²çµ„æ²’æœ‰æˆå“¡');

             // --- è¨ˆç®—æ¯ä½æˆå“¡çš„ä¸­çæ¬Šé‡ ---
             let candidates = team.members.map(member => {
                 let weight = 10; // åŸºç¤æ¬Šé‡

                 // æ¢ä»¶ A: åˆ†æ•¸ä½æˆ–æ˜¯å°šæœªå–å¾—åˆ†æ•¸ (0åˆ†è€…æ¬Šé‡ +100ï¼Œåˆ†æ•¸ä½æ–¼å¹³å‡è€… +30)
                 const score = member.score || 0;
                 if (score === 0) {
                     weight += 100;
                 } else if (score < (team.score / team.members.length)) { 
                     // å¦‚æœå€‹äººåˆ†æ•¸ä½æ–¼è©²çµ„å¹³å‡
                     weight += 30;
                 }

                 // è¨ˆç®—è©²ç©å®¶ç›®å‰æ“æœ‰çš„é“å…·ç¸½æ•¸
                 const items = member.items || {};
                 const totalItems = (items.hint||0) + (items.double||0) + (items.horus||0) + (items.nile||0);

                 // æ¢ä»¶ B: å°šæœªç²å¾—éé“å…· (é“å…·ç¸½æ•¸ç‚º 0 è€…æ¬Šé‡ +80)
                 if (totalItems === 0) {
                     weight += 80;
                 }

                 // æ¢ä»¶ C: é“å…·å–å¾—æ¬¡æ•¸è¶Šå°‘ï¼Œæ©Ÿç‡è¶Šé«˜ (æ¯å¤šä¸€å€‹é“å…·ï¼Œæ¬Šé‡ç¨å¾®æ‰£æ¸›ï¼Œä½†æœ€ä½ä¿ç•™ 5)
                 // ä¾‹å¦‚ï¼š0é“å…·(+0æ‰£æ¸›), 1é“å…·(-10), 2é“å…·(-20)...
                 weight -= (totalItems * 10);
                 if (weight < 5) weight = 5; // ä¿åº•æ¬Šé‡ï¼Œé¿å…è®Šæˆ 0 æ©Ÿç‡

                 return { member: member, weight: weight };
             });

             // --- åŠ æ¬Šéš¨æ©Ÿæ¼”ç®—æ³• ---
             const totalWeight = candidates.reduce((sum, c) => sum + c.weight, 0);
             let randomValue = Math.random() * totalWeight;
             let luckyMember = candidates[0].member;

             for (let i = 0; i < candidates.length; i++) {
                 randomValue -= candidates[i].weight;
                 if (randomValue <= 0) {
                     luckyMember = candidates[i].member;
                     break;
                 }
             }
             
             console.log(`é“å…·ç™¼é€ï¼š${luckyMember.name} (æ¬Šé‡: ${candidates.find(c=>c.member===luckyMember).weight}/${totalWeight})`);

             // --- åŸ·è¡Œç™¼é€ (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒ) ---
             const itemRef = db.ref(`classes/${app.state.classId}/players/${teamKey}/${luckyMember.name}/items/${type}`);
             itemRef.transaction((currentCount) => {
                 return (currentCount || 0) + 1;
             }, (error, committed) => {
                 if (committed) {
                     const itemNames = {
                         hint: 'ğŸ“œ å¤è€æç¤ºå¡',
                         double: 'ğŸ¦‚ è–ç”²èŸ²ç¥ç¦',
                         horus: 'ğŸ‘ï¸ è·é­¯æ–¯ä¹‹çœ¼',
                         nile: 'ğŸŒŠ å°¼ç¾…æ²³æ©è³œ'
                     };
                     const itemName = itemNames[type] || 'ğŸ ç¥ç§˜é“å…·';
                     app.toast(`ğŸ å·²è³œäºˆ ${luckyMember.name}ï¼š${itemName}`);
                     // é€™è£¡é¸æ“‡ä¸é—œé–‰è¦–çª—ï¼Œè®“è€å¸«å¯ä»¥é€£çºŒç™¼é€
                     // app.el('team-modal').classList.add('hidden'); 
                 }
             });
        },

        updateDiceUI: (dice) => {
            ['d8', 'd10', 'd12'].forEach(k => {
                app.el(`t-dice-${k.slice(1)}`).textContent = dice[k];
                app.el(`s-dice-${k.slice(1)}`).textContent = dice[k];
            });
            app.state.dice = dice;
        },

       renderPyramid: (pyramidData) => {
            const board = app.el('pyramid-board');
            if (!pyramidData) return;
            
            const cardSizeClass = "w-20 h-24 md:w-24 md:h-28 flex-shrink-0";
            const rows = [[0], [1,2], [3,4,5], [6,7,8,9]];
            let html = '';
            
            rows.forEach(rowIndices => {
                html += '<div class="flex justify-center mb-3 gap-2">'; 
                rowIndices.forEach(idx => {
                    const card = pyramidData[idx];
                    if (card) {
                        const isSelected = app.state.selectedCardIndex === idx;
                        const ringClass = isSelected ? 'ring-4 ring-green-500 scale-110 z-10' : '';
                        const colorClass = app.getCardColorClass(card.color);
                        const visibilityClass = card.isTaken ? 'opacity-0 pointer-events-none' : 'opacity-100';
                        
                        html += `<div onclick="app.studentSelectCard(${idx})" class="${cardSizeClass} rounded-xl shadow-lg cursor-pointer transition-all duration-200 ${colorClass} ${ringClass} ${visibilityClass} flex items-center justify-center font-black relative border-2 border-white/20"><div class="absolute top-1 right-2 text-sm opacity-60 font-bold">${card.points}</div><span class="pyramid-num-lg drop-shadow-md">${card.number}</span></div>`;
                    } else {
                        html += `<div class="${cardSizeClass} rounded-xl border-4 border-dashed border-amber-300/50 bg-white/20"></div>`;
                    }
                });
                html += '</div>';
            });

            board.innerHTML = html;
            
            const decks = app.state.gameData.decks || {};
            app.el('count-black').textContent = decks.black ? decks.black.length : 0;
            app.el('count-red').textContent = decks.red ? decks.red.length : 0;
            app.el('count-blue').textContent = decks.blue ? decks.blue.length : 0;
            app.el('count-yellow').textContent = decks.yellow ? decks.yellow.length : 0;
        },

        studentSelectCard: (index) => {
            if (app.state.role !== 'student') return;
            if (app.state.gameData.status !== 'playing') return app.toast('âœ‹ ç¾åœ¨é‚„ä¸èƒ½é¸å¡ç‰‡å–”');
            
            app.state.selectedCardIndex = index;
            app.renderPyramid(app.state.gameData.pyramid);
            app.renderFormulaInput(); // ç¢ºä¿é¸æ“‡å¾Œä¹Ÿèƒ½çœ‹è¦‹æ¸¸æ¨™
            app.toast(`å·²é¸æ“‡ç›®æ¨™ï¼š${app.state.gameData.pyramid[index].number}`);
        },

        teacherGetHint: () => {
            if (app.state.gameData.status !== 'playing') return app.toast('âš ï¸ è«‹å…ˆæ“²éª°å­ä¸¦é–‹å§‹éŠæˆ²');
            const { d8, d10, d12 } = app.state.gameData.dice;
            const solution = app.findSolution([d8, d10, d12]);
            
            if (solution) {
    const match = solution.match(/(\d+\s*[\+\-\*\/]\s*\d+)/);
    let hint = match ? match[0] : solution;

    // [ä¿®æ­£] è¦–è¦ºä¸Šé¡¯ç¤ºç‚º Ã— å’Œ Ã·
    let displayHint = hint.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·');

    app.el('solution-hint-text').textContent = `(${displayHint}) ... ?`;
    app.el('solution-modal').classList.remove('hidden');

    // èªéŸ³éƒ¨åˆ†ç”± speak å‡½å¼çµ±ä¸€è™•ç†
    app.speak("æ³•è€ç‹æç¤ºï¼š" + hint);
} else {
                app.toast("âš ï¸ ç›®å‰çš„éª°å­ä¼¼ä¹ç„¡è§£...");
            }
        },

      teacherRollDice: () => {
            if (app.state.gameData.status === 'rolling' || app.state.gameData.status === 'playing') return;

            db.ref(`classes/${app.state.classId}`).update({
                status: 'rolling',
                dice: { d8: '?', d10: '?', d12: '?' }
            });
            
            if (app.state.voiceEnabled) app.speak("å‘½é‹ä¹‹éª°è½‰å‹•ä¸­...");

            const rollInterval = setInterval(() => {
                app.el('t-dice-8').textContent = Math.floor(Math.random() * 8) + 1;
                app.el('t-dice-10').textContent = Math.floor(Math.random() * 10) + 1;
                app.el('t-dice-12').textContent = Math.floor(Math.random() * 12) + 1;
            }, 80);

            setTimeout(() => {
                clearInterval(rollInterval);
                const d8 = Math.floor(Math.random() * 8) + 1;
                const d10 = Math.floor(Math.random() * 10) + 1;
                const d12 = Math.floor(Math.random() * 12) + 1;
                
                const activeTargets = app.state.gameData.pyramid.filter(c => c && !c.isTaken).map(c => c.number);
                let hasSolution = false;
                for (let target of activeTargets) {
                    if (app.findSolution([d8, d10, d12], target)) { hasSolution = true; break; }
                }

                if (!hasSolution) {
                    // v3.2.4: ç™¼ç¾ç„¡è§£ï¼Œå¯«å…¥è³‡æ–™åº« 'dead_end' ç‹€æ…‹ï¼Œè®“å­¸ç”Ÿç«¯åŒæ­¥é¡¯ç¤ºèˆ‡ç™¼è²
                    db.ref(`classes/${app.state.classId}`).update({ 
                        status: 'dead_end',
                        dice: { d8, d10, d12 } 
                    });
                    
                    const msg = `æ“²å‡º ${d8}, ${d10}, ${d12}ã€‚æ­¤å±€ç„¡è§£ï¼4ç§’å¾Œé‡æ–°é–‹å§‹`;
                    if (app.state.voiceEnabled) app.speak(msg);
                    
                    // è€å¸«ç«¯ 4 ç§’å¾Œè‡ªå‹•è§¸ç™¼ä¸‹ä¸€å±€
                    setTimeout(() => app.forceNextRound(), 4000);
                } else {
                    db.ref(`classes/${app.state.classId}`).update({
                        status: 'playing',
                        dice: { d8, d10, d12 },
                        timerActive: false,
                        timer: 30
                    });
                    if (app.state.voiceEnabled) app.speak(`æ“²éª°çµæœï¼š${d8}ã€${d10}ã€${d12}ã€‚`);
                }
            }, 1500);
        },

        // [v3.1.0] å…¨æ–°ç™»å‡ºé‚è¼¯ï¼šæ¸…é™¤æœ¬åœ°ç‹€æ…‹ -> é‡æ•´é é¢
        logout: () => {
            localStorage.removeItem('pharaoh_v3_state'); // æ¸…é™¤è‡ªå‹•ç™»å…¥ç´€éŒ„
            location.reload(); // é‡æ•´å¾Œæœƒå›åˆ°è§’è‰²é¸æ“‡é é¢
        },

       // [v3.1.0] ä¸‹è¼‰éŠæˆ²è³‡æ–™ (HTML å ±è¡¨)
        downloadGameData: () => {
            const players = app.state.gameData.players || {};
            const date = new Date().toLocaleDateString();
            const classId = app.state.classId;
            
            let tableRows = '';
            // æ•´ç†è³‡æ–™
            let allPlayers = [];
            Object.keys(players).forEach(teamKey => {
                Object.values(players[teamKey]).forEach(p => {
                    allPlayers.push({...p, teamName: app.getTeamName(teamKey)});
                });
            });
            allPlayers.sort((a, b) => b.score - a.score);

            allPlayers.forEach((p, i) => {
                tableRows += `<tr style="background:${i%2===0?'#fff':'#f9fafb'}"><td style="padding:10px;border:1px solid #ddd;text-align:center">${i+1}</td><td style="padding:10px;border:1px solid #ddd">${p.name}</td><td style="padding:10px;border:1px solid #ddd">${p.teamName}</td><td style="padding:10px;border:1px solid #ddd;font-weight:bold;color:#b45309">${p.score}</td></tr>`;
            });

            // å»ºç«‹ç°¡æ˜“ HTML å ±è¡¨
            const reportHTML = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>ç¥æ®¿è©¦ç…‰æˆ°ç¸¾è¡¨ - ${classId}</title><style>body{font-family:sans-serif;padding:20px;background:#fffbeb}table{width:100%;border-collapse:collapse;margin-top:20px;background:white}th{background:#d97706;color:white;padding:12px}h1{color:#92400e}</style></head><body><h1>ğŸº æ³•è€å¯†ç¢¼æˆ°ç¸¾è¡¨</h1><p><strong>ç­ç´šä»£ç¢¼ï¼š</strong>${classId} <span style="margin-left:20px"><strong>æ—¥æœŸï¼š</strong>${date}</span></p><table><thead><tr><th>æ’å</th><th>å§“å</th><th>å°çµ„</th><th>åˆ†æ•¸</th></tr></thead><tbody>${tableRows}</tbody></table><p style="margin-top:20px;color:#666;font-size:12px">ç”± æ³•è€å¯†ç¢¼ v3.2.6 ç³»çµ±è‡ªå‹•ç”Ÿæˆ</p></body></html>`;

            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¥æ®¿è©¦ç…‰_æˆ°ç¸¾_${classId}_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            app.toast('ğŸ“¥ æˆ°ç¸¾è¡¨ä¸‹è¼‰ä¸­...');
        },

       // [v3.1.2] å„ªåŒ–å¾Œçš„é‡ç½®é‚è¼¯ï¼šä½¿ç”¨ Promise é¿å…é˜»å¡ä¸»åŸ·è¡Œç·’
       // [v3.1.5] å„ªåŒ–å¾Œçš„é‡ç½®é‚è¼¯ï¼šè¨­å®šç‹€æ…‹è®“æ‰€æœ‰äººçœ‹åˆ°ã€Œå›åˆ°åˆå§‹ä¹‹åœ°ã€æŒ‰éˆ•
        resetGame: async () => {
             if(!confirm('âš ï¸ ç¢ºå®šè¦é–‹å•Ÿæ–°çš„ä¸€å±€å—ï¼Ÿ\n\n1. æ‰€æœ‰åˆ†æ•¸å°‡æ­¸é›¶ã€‚\n2. æ‰€æœ‰äººå°‡çœ‹åˆ°ã€Œå›åˆ°åˆå§‹ä¹‹åœ°ã€æŒ‰éˆ•ã€‚\n3. è«‹ç¢ºèªå·²ä¸‹è¼‰æˆ°ç¸¾è¡¨ã€‚')) {
                 return;
             }

             try {
                 app.el('game-over-modal').classList.add('hidden');
                 app.state.isResetting = true; // æ¨™è¨˜è‡ªå·±ï¼Œé¿å…ç•«é¢é–ƒçˆ

                 // 1. ç”¢ç”Ÿæ–°çš„éŠæˆ²åˆå§‹è³‡æ–™
                 const initialData = app.generateInitialGameData();
                 
                 // 2. è¨­å®šè³‡æ–™åº«ç‹€æ…‹ç‚º reset_completedï¼Œä¸¦é‡ç½®æ‰€æœ‰è³‡æ–™
                 // é€™æ¨£æ‰€æœ‰å®¢æˆ¶ç«¯æ”¶åˆ°é€šçŸ¥å¾Œï¼Œå°±æœƒé¡¯ç¤ºå…¨è¢å¹•çš„æŒ‰éˆ•
                 await db.ref(`classes/${app.state.classId}`).set({
                    status: 'reset_completed', 
                    dice: { d8: '-', d10: '-', d12: '-' },
                    round: 1,
                    timer: 30,
                    timerActive: false,
                    pyramid: initialData.pyramid,
                    decks: initialData.decks,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
                 
                 app.toast('ğŸ”„ éŠæˆ²å·²é‡ç½®ï¼Œç­‰å¾…å†’éšªè€…å›æ­¸...');
                 
                 // è€å¸«è‡ªå·±ä¹Ÿé¡¯ç¤ºè©²é®ç½© (ç”± listenToGameData è™•ç†)
                 
             } catch (err) {
                 console.error("Reset failed:", err);
                 alert('é‡ç½®éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†é é¢ã€‚');
                 location.reload();
             }
        },
        
        forceNextRound: () => {
             const gameData = app.state.gameData;
             if (!gameData || !gameData.decks) return;

             const newPyramid = [...(gameData.pyramid || [])];
             const newDecks = JSON.parse(JSON.stringify(gameData.decks));
             let hasRefilled = false;
             let cannotRefill = false;

             const slots = [
                 {idx:0, color:'black'}, {idx:1, color:'red'}, {idx:2, color:'red'},
                 {idx:3, color:'blue'}, {idx:4, color:'blue'}, {idx:5, color:'blue'},
                 {idx:6, color:'yellow'}, {idx:7, color:'yellow'}, {idx:8, color:'yellow'}, {idx:9, color:'yellow'}
             ];

             slots.forEach(slot => {
                 if (!newPyramid[slot.idx] || newPyramid[slot.idx].isTaken) {
                     if (newDecks[slot.color] && newDecks[slot.color].length > 0) {
                         newPyramid[slot.idx] = newDecks[slot.color].pop(); 
                         hasRefilled = true;
                     } else {
                         newPyramid[slot.idx] = null;
                         cannotRefill = true;
                     }
                 }
             });

             if (cannotRefill) {
                 app.triggerEndGame();
                 app.toast('ğŸ ç‰Œåº«è€—ç›¡ï¼Œå†’éšªçµæŸï¼');
             } else {
                 db.ref(`classes/${app.state.classId}`).update({
                     status: 'waiting',
                     dice: {d8:'-', d10:'-', d12:'-'},
                     timerActive: false,
                     pyramid: newPyramid,
                     decks: newDecks,
                     round: (gameData.round || 1) + 1
                 });
                 app.toast(hasRefilled ? 'å·²é€²å…¥ä¸‹ä¸€å›åˆä¸¦è£œç‰Œ' : 'å·²é€²å…¥ä¸‹ä¸€å›åˆ');
             }
        },

        // v3.0.9: è§¸ç™¼éŠæˆ²çµæŸ
        triggerEndGame: () => {
            if (app.state.role === 'teacher') {
                db.ref(`classes/${app.state.classId}`).update({
                    status: 'ended',
                    timerActive: false
                });
            }
        },
        
        

        getTeamName: (key) => {
            const map = {
                team1: 'ç¬¬1çµ„:é˜¿åŠªæ¯”æ–¯', team2: 'ç¬¬2çµ„:è·é­¯æ–¯', team3: 'ç¬¬3çµ„:å·´æ–¯æ³°ç‰¹',
                team4: 'ç¬¬4çµ„:æ­è¥¿é‡Œæ–¯', team5: 'ç¬¬5çµ„:ä¼Šè¥¿æ–¯', team6: 'ç¬¬6çµ„:å¤ªé™½ç¥æ‹‰'
            };
            return map[key] || key;
        },
        
        getTeamShortName: (key) => {
             const map = { team1: 'é˜¿åŠªæ¯”æ–¯', team2: 'è·é­¯æ–¯', team3: 'å·´æ–¯æ³°ç‰¹', team4: 'æ­è¥¿é‡Œæ–¯', team5: 'ä¼Šè¥¿æ–¯', team6: 'å¤ªé™½ç¥æ‹‰' };
             return map[key] || '';
        },

        // --- 6. v3.0.8 å¼·åŒ–ç‰ˆè¼¸å…¥æ§åˆ¶ ---
        renderFormulaInput: () => {
            const displayEl = app.el('formula-display');
            const val = app.state.inputFormula;
            const pos = app.state.inputCursorPos;
            
            // æ’å…¥æ¸¸æ¨™ HTML
            const part1 = val.substring(0, pos);
            const part2 = val.substring(pos);
            
            // å¦‚æœå…§å®¹ç‚ºç©ºï¼Œé¡¯ç¤ºæç¤ºå­— (ä½†ä¿ç•™æ¸¸æ¨™)
            if (val === '') {
                displayEl.innerHTML = `<span class="cursor-blink"></span><span class="text-gray-300 ml-1">é»æ“Šä¸‹æ–¹æŒ‰éˆ•</span>`;
            } else {
                displayEl.innerHTML = `${part1}<span class="cursor-blink"></span>${part2}`;
            }
        },

        resetInput: () => {
            app.state.inputFormula = "";
            app.state.inputCursorPos = 0;
            app.renderFormulaInput();
        },

        inputChar: (char) => {
            if (app.state.role !== 'student') return;
            const val = app.state.inputFormula;
            const pos = app.state.inputCursorPos;
            
            app.state.inputFormula = val.substring(0, pos) + char + val.substring(pos);
            app.state.inputCursorPos = pos + String(char).length;
            app.renderFormulaInput();
        },

        backspace: () => {
             const val = app.state.inputFormula;
             const pos = app.state.inputCursorPos;
             if (pos > 0) {
                 app.state.inputFormula = val.substring(0, pos - 1) + val.substring(pos);
                 app.state.inputCursorPos = pos - 1;
             }
             app.renderFormulaInput();
        },

        moveCursor: (direction) => {
            const pos = app.state.inputCursorPos;
            const len = app.state.inputFormula.length;
            app.state.inputCursorPos = direction === -1 ? Math.max(0, pos - 1) : Math.min(len, pos + 1);
            app.renderFormulaInput();
        },

     // v3.3.0 æ›´æ–°ï¼šé©—è­‰é‚è¼¯ (æ”¯æ´è·é­¯æ–¯ä¹‹çœ¼èˆ‡å°¼ç¾…æ²³æ©è³œ)
       // v3.3.1 æ›´æ–°ï¼šé©—è­‰é‚è¼¯ (ä¿®æ­£å°¼ç¾…æ²³æŒçºŒæ•ˆæœèˆ‡è·é­¯æ–¯æ¶ˆè€—)
      // v3.3.2 ä¿®æ­£ï¼šå¼·åˆ¶éª°å­å‹åˆ¥è½‰æ›ï¼Œä¿®å¾©é“å…·å¡é©—è­‰éŒ¯èª¤èˆ‡å››å‰‡é‹ç®—ç¬¦è™Ÿé‚è¼¯
        submitAnswer: () => {
            const idx = app.state.selectedCardIndex;
            if (idx === null) return app.toast('âš ï¸ è«‹å…ˆé»æ“Šé‡‘å­—å¡”ä¸Šçš„æ•¸å­—ï¼');
            
            const card = app.state.gameData.pyramid[idx];
            if (!card || card.isTaken) return app.toast('ğŸš« æ™šäº†ä¸€æ­¥ï¼é€™å¼µç‰Œå·²ç¶“è¢«æ‹¿èµ°äº†ã€‚');
            
            const formula = app.state.inputFormula;
            const rawDice = app.state.dice;
            
            // ã€ä¿®æ­£é—œéµ 1ã€‘å¼·åˆ¶å°‡éª°å­é»æ•¸è½‰ç‚º Number å‹åˆ¥ï¼Œé¿å…èˆ‡ Firebase çš„ String å‹åˆ¥ç™¼ç”Ÿè¡çª
            // åŒæ™‚é€²è¡Œæ’åºï¼Œç¢ºä¿æ¯”å°æ™‚é †åºä¸€è‡´
            const diceNums = [rawDice.d8, rawDice.d10, rawDice.d12]
                             .map(n => Number(n)) 
                             .sort((a,b) => a - b);
            
            // ã€ä¿®æ­£é—œéµ 2ã€‘è§£æå…¬å¼ä¸­çš„æ•¸å­—æ™‚ï¼Œç¢ºä¿ä¸å— Ã— Ã· ç¬¦è™Ÿå½±éŸ¿
            const formulaNums = (formula.match(/\d+/g) || [])
                                .map(Number)
                                .sort((a,b) => a - b);
            
            const activeItem = app.state.activeItem;
            let isUsageValid = false;

            // --- æ­¥é©Ÿ 1: é©—è­‰æ•¸å­—ä½¿ç”¨è¦å‰‡ (é“å…·é‚è¼¯ä¿®æ­£) ---
            if (activeItem === 'nile') {
                // ğŸŒŠ å°¼ç¾…æ²³æ©è³œï¼šè¦å‰‡æ˜¯ã€Œåªéœ€å…©é¡†ã€ï¼Œä½†ä¹Ÿå®¹è¨±ã€Œä½¿ç”¨ä¸‰é¡†ã€çš„æ¨™æº–è§£æ³•
                if (formulaNums.length === 2) {
                    const tempDice = [...diceNums];
                    let matchCount = 0;
                    formulaNums.forEach(num => {
                        // ä½¿ç”¨ indexOf å°‹æ‰¾æ•¸å­— (å› ç‚ºéƒ½è½‰ç‚º Number äº†ï¼Œé€™è£¡æœƒæº–ç¢º)
                        const foundIdx = tempDice.indexOf(num);
                        if (foundIdx !== -1) {
                            tempDice.splice(foundIdx, 1);
                            matchCount++;
                        }
                    });
                    if (matchCount === 2) isUsageValid = true;
                }
                // å¦‚æœç©å®¶é–‹äº†å°¼ç¾…æ²³ä½†ç”¨äº† 3 é¡†éª°å­ï¼Œæˆ‘å€‘ä¹Ÿè¦–ç‚ºåˆæ³• (ç›¸å®¹æ¨™æº–è¦å‰‡)
                if (formulaNums.length === 3 && JSON.stringify(diceNums) === JSON.stringify(formulaNums)) {
                    isUsageValid = true;
                }
                
                if (!isUsageValid) return app.toast('âŒ å°¼ç¾…æ²³è¦å‰‡ï¼šè«‹è¼¸å…¥åŒ…å«ã€Œ2é¡†ã€éª°å­æ•¸å­—çš„å…¬å¼ã€‚');

            } else if (activeItem === 'horus') {
                // ğŸ‘ï¸ è·é­¯æ–¯ä¹‹çœ¼ï¼š2é¡†åŸéª°å­ + 1é¡†è®Šèº«æ•¸å­—(1~3)
                if (formulaNums.length === 3) {
                    const tempDice = [...diceNums];
                    let matchCount = 0;
                    let wildcardUsed = false;

                    // å…ˆæŠŠè·Ÿéª°å­å®Œå…¨ç¬¦åˆçš„æ•¸å­—æ‰£æ‰
                    const remainingFormulaNums = [];
                    formulaNums.forEach(num => {
                        const foundIdx = tempDice.indexOf(num);
                        if (foundIdx !== -1) {
                            tempDice.splice(foundIdx, 1); // æ‰¾åˆ°å°±ç§»é™¤ï¼Œé¿å…é‡è¤‡è¨ˆç®—
                            matchCount++;
                        } else {
                            remainingFormulaNums.push(num);
                        }
                    });

                    // æª¢æŸ¥å‰©ä¸‹çš„é‚£å€‹æ•¸å­—æ˜¯å¦ç‚º 1~3 (ä¸”è¦æ˜¯åŸæœ¬éª°å­è£¡æ²’æœ‰çš„ï¼Œæˆ–è€…æ˜¯é‡è¤‡ä½¿ç”¨äº†è®Šèº«å¾Œçš„æ•¸å­—)
                    if (matchCount === 2 && remainingFormulaNums.length === 1) {
                        const wildcard = remainingFormulaNums[0];
                        if (wildcard >= 1 && wildcard <= 3) {
                            isUsageValid = true;
                        }
                    }
                    // å¦‚æœç©å®¶é–‹äº†è·é­¯æ–¯ä½†æ²’ç”¨è®Šèº«åŠŸèƒ½ (ç›´æ¥ç”¨åŸæœ¬3é¡†)ï¼Œä¹Ÿç®—éé—œ
                    if (matchCount === 3) isUsageValid = true;
                }
                if (!isUsageValid) return app.toast('âŒ è·é­¯æ–¯è¦å‰‡ï¼šéœ€ç”¨ 2 é¡†åŸéª°å­ + 1 é¡†è®Šèº«æ•¸å­—(1~3)ã€‚');

            } else {
                // ğŸŸ¢ é è¨­è¦å‰‡ (åŒ…å«è–ç”²èŸ² double)ï¼šå¿…é ˆå®Œå…¨ç”¨å®Œ 3 é¡†éª°å­
                // å› ç‚ºå‰é¢å·²ç¶“å¼·åˆ¶è½‰å‹ Number ä¸”æ’åºï¼Œé€™è£¡çš„ stringify æ¯”å°å°±æœƒæº–ç¢º
                if (JSON.stringify(diceNums) === JSON.stringify(formulaNums)) {
                    isUsageValid = true;
                }
                if (!isUsageValid) return app.toast('âŒ æ•¸å­—éŒ¯èª¤ï¼è«‹ç”¨å®Œæ‰€æœ‰éª°å­ã€‚');
            }

            // --- æ­¥é©Ÿ 2: é©—è­‰é‹ç®—çµæœ ---
            try {
                // ã€ä¿®æ­£é—œéµ 3ã€‘ç¢ºä¿é‹ç®—ç¬¦è™Ÿæ›¿æ›æ­£ç¢ºï¼šå°‡é¡¯ç¤ºç”¨çš„ Ã— Ã· è½‰ç‚ºé‹ç®—ç”¨çš„ * /
                const codeFormula = formula.replace(/Ã—/g, '*').replace(/Ã·/g, '/');

                // å®‰å…¨éæ¿¾ï¼šåªå…è¨±æ•¸å­—ã€é‹ç®—ç¬¦è™Ÿå’Œå°æ•¸é»
                const cleanFormula = codeFormula.replace(/[^-()\d/*+.]/g, '');
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å«éæ³•å­—å…ƒæˆ–ç©ºå­—ä¸²
                if (!cleanFormula || /[^0-9+\-*/(). ]/.test(cleanFormula)) {
                    throw new Error('Invalid formula');
                }

                // åŸ·è¡Œé‹ç®—
                const result = new Function(`return ${cleanFormula}`)();
                
                // æª¢æŸ¥çµæœ (å®¹è¨±æ¥µå°çš„å°æ•¸èª¤å·®)
                if (Math.abs(result - card.number) < 0.001) {
                    // --- é©—è­‰æˆåŠŸ ---
                    let points = card.points;
                    let playerName = app.state.myName;
                    let successMsg = `æ­å–œå†’éšªè€…${playerName}è§£è¬æˆåŠŸï¼`;
                    let itemToConsume = null;

                    // é“å…·çµç®—é‚è¼¯
                    if (activeItem === 'double') {
                        points *= 2;
                        successMsg = `æ­å–œ${playerName}ï¼è–ç”²èŸ²ç™¼å¨ï¼Œåˆ†æ•¸é›™å€ï¼`;
                        itemToConsume = 'double';
                        app.state.activeItem = null; // æ¶ˆè€—å¾Œé‡ç½®
                    } else if (activeItem === 'horus') {
                        successMsg = `æ­å–œ${playerName}ï¼è·é­¯æ–¯ä¹‹åŠ›ç ´è§£æˆåŠŸï¼`;
                        itemToConsume = 'horus';
                        app.state.activeItem = null; 
                    } else if (activeItem === 'nile') {
                        successMsg = `æ­å–œ${playerName}ï¼å°¼ç¾…æ²³æ©è³œé‹ç®—æˆåŠŸï¼`;
                        itemToConsume = 'nile';
                        // å°¼ç¾…æ²³é€šå¸¸æ˜¯ä¸€å›åˆæ•ˆæœï¼Œé€™è£¡é¸æ“‡æ¶ˆè€—ä¸€å¼µ
                    }

                    // æ‰£é™¤é“å…·æ•¸é‡
                    if (itemToConsume) {
                        const itemRef = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/${itemToConsume}`);
                        itemRef.transaction(count => Math.max(0, (count || 0) - 1));
                    }

                    // æ›´æ–°å¾Œç«¯è³‡æ–™
                    app.renderStudentInventory(app.state.gameData.players);
                    app.renderActiveItemStatus(); // æ›´æ–°é“å…·ç‹€æ…‹æ¬„

                    const updates = {};
                    updates[`pyramid/${idx}/isTaken`] = true;
                    
                    const scorePath = `players/${app.state.myTeam}/${app.state.myName}/score`;
                    const currentScore = (app.state.gameData.players?.[app.state.myTeam]?.[app.state.myName]?.score || 0);
                    updates[scorePath] = currentScore + points;
                    
                    updates['lastWinner'] = {
                        name: app.state.myName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    if (!app.state.gameData.timerActive) {
                        updates['timerActive'] = true;
                        updates['timer'] = 30;
                        app.speak(successMsg + " å•Ÿå‹•æ’¤é€€æ™‚é–“ï¼");
                    } else {
                        app.speak(successMsg + " å†æ‹¿ä¸€å¼µï¼");
                    }

                    db.ref(`classes/${app.state.classId}`).update(updates);
                    app.resetInput();
                    app.state.selectedCardIndex = null;
                } else {
                    // å››æ¨äº”å…¥é¡¯ç¤ºçµæœ
                    const displayResult = Math.round(result * 100) / 100;
                    app.toast(`âŒ è¨ˆç®—çµæœæ˜¯ ${displayResult}ï¼Œç›®æ¨™æ˜¯ ${card.number} å–”ï¼`);
                }
            } catch (e) {
                console.error(e);
                app.toast('âŒ å…¬å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‹¬è™Ÿæˆ–é‹ç®—ç¬¦è™Ÿã€‚');
            }
        },

      handleTimeUp: () => {
            // v3.2.4: æ™‚é–“åˆ°ï¼Œè‡ªå‹•æ›ä¸‹ä¸€å±€
            if (app.state.voiceEnabled) app.speak("æ™‚é–“åˆ°ï¼æº–å‚™é€²å…¥ä¸‹ä¸€å›åˆã€‚");
            
            // è€å¸«ç«¯è‡ªå‹•åŸ·è¡Œæ›å±€é‚è¼¯
            if (app.state.role === 'teacher') {
                // çµ¦äºˆ 2 ç§’ç·©è¡è®“èªéŸ³æ’­å®Œ
                setTimeout(() => {
                    app.forceNextRound();
                }, 2000);
            }
        },

        findSolution: (nums, specificTarget = null) => {
             const ops = ['+', '-', '*', '/']; 
             let targets = [];
             if (specificTarget !== null) {
                 targets = [specificTarget];
             } else {
                 targets = app.state.gameData.pyramid.filter(c => c && !c.isTaken).map(c => c.number);
             }
             
             function getPermutations(arr) { if (arr.length === 1) return [arr]; const perms = []; for (let i = 0; i < arr.length; i++) { const first = arr[i], rest = arr.slice(0, i).concat(arr.slice(i + 1)); getPermutations(rest).forEach(sub => perms.push([first, ...sub])); } return perms; }
             
             for (const p of getPermutations(nums)) {
                const [a, b, c] = p;
                for (const op1 of ops) for (const op2 of ops) {
                    try { 
                        let f1 = `(${a} ${op1} ${b}) ${op2} ${c}`;
                        let r1 = eval(f1);
                        if (targets.some(t => Math.abs(t - r1) < 0.001)) return f1;
                        
                        let f2 = `${a} ${op1} (${b} ${op2} ${c})`;
                        let r2 = eval(f2);
                        if (targets.some(t => Math.abs(t - r2) < 0.001)) return f2;
                    } catch(e){}
                }
             }
             return null;
        },

        toast: (msg) => {
            const el = app.el('msg-toast');
            el.textContent = msg;
            el.style.opacity = '1';
            el.style.top = '100px';
            // æ¸…é™¤èˆŠçš„ timer ä»¥å…é–ƒçˆ
            if(app.state.toastTimer) clearTimeout(app.state.toastTimer);
            app.state.toastTimer = setTimeout(() => { el.style.opacity = '0'; el.style.top = '20px'; }, 2000);
            app.speak(msg);
        },

        speak: (text) => {
    if (app.state.role === 'teacher' && app.state.voiceEnabled && window.speechSynthesis) {
        // v3.1.5 ä¿®æ­£ï¼šå¼·åˆ¶ä¸­æ–·ä¸Šä¸€å¥ï¼Œé¿å…èªéŸ³é‡ç–Š
        window.speechSynthesis.cancel();

        // [ä¿®æ­£] èªéŸ³å£èªåŒ–è½‰æ›ï¼šå°‡ç¬¦è™Ÿè½‰ç‚ºä¸­æ–‡
        let spokenText = text
            .replace(/\*/g, 'ä¹˜ä»¥')   // é›»è…¦ç¬¦è™Ÿ * -> ä¹˜ä»¥
            .replace(/\//g, 'é™¤ä»¥')   // é›»è…¦ç¬¦è™Ÿ / -> é™¤ä»¥
            .replace(/Ã—/g, 'ä¹˜ä»¥')    // æ•¸å­¸ç¬¦è™Ÿ Ã— -> ä¹˜ä»¥
            .replace(/Ã·/g, 'é™¤ä»¥')    // æ•¸å­¸ç¬¦è™Ÿ Ã· -> é™¤ä»¥
            .replace(/-/g, 'æ¸›')      // æ¸›è™Ÿå”¸èµ·ä¾†é †ä¸€é»
            .replace(/\+/g, 'åŠ ');    // åŠ è™Ÿå”¸èµ·ä¾†é †ä¸€é»

        // ç§»é™¤è¡¨æƒ…ç¬¦è™Ÿï¼Œé¿å…èªéŸ³å¼•æ“è®€å‡ºäº‚ç¢¼
        const cleanText = spokenText.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');

        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'zh-TW';
        u.rate = 0.9; // [å»ºè­°] ç¨å¾®æ”¾æ…¢èªé€Ÿï¼Œè®“ç®—å¼è½å¾—æ›´æ¸…æ¥š
        window.speechSynthesis.speak(u);
    }
},
        
        toggleVoice: () => {
            app.state.voiceEnabled = !app.state.voiceEnabled;
            app.el('voice-toggle-btn').textContent = app.state.voiceEnabled ? "ğŸ”Š èªéŸ³é–‹" : "ğŸ”‡ èªéŸ³é—œ";
        },

        generatePredefinedCards: () => { /* ä½”ä½ç¬¦ */ },
        createPredefinedCards: () => { /* ä½”ä½ç¬¦ */ },
        getCardColorClass: (c) => { return { black: 'bg-slate-900 text-white', red: 'bg-red-600 text-white', blue: 'bg-blue-600 text-white', yellow: 'bg-yellow-400 text-black' }[c] || 'bg-gray-200'; },
        
        shuffle: (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        createFullDeck: () => {
            const data = {
                black: { n: [49, 64, 84, 90], p: 6 },
                red: { n: [23, 26, 33, 44, 50, 54, 63, 70, 80], p: 4 },
                blue: { n: [19, 22, 25, 27, 28, 32, 35, 42, 45, 48, 56, 60, 72], p: 2 },
                yellow: { n: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 24, 30, 36, 40], p: 1 }
            };
            const decks = {};
            Object.keys(data).forEach(color => {
                decks[color] = app.shuffle([...data[color].n]).map(num => ({
                    number: num, color: color, points: data[color].p, isTaken: false
                }));
            });
            return decks;
        },

        // v3.3.1 æ›´æ–°ï¼šæ¸²æŸ“å­¸ç”ŸèƒŒåŒ… (æ”¯æ´å››ç¨®é“å…·ï¼Œæ¶ˆé™¤ç©ºç™½ç¯€é»)
       // v3.3.1 æ›´æ–°ï¼šæ¸²æŸ“å­¸ç”ŸèƒŒåŒ… (æ”¯æ´å››ç¨®é“å…·ï¼Œæ¶ˆé™¤ç©ºç™½ç¯€é»)
        renderStudentInventory: (players) => {
            // [BUGä¿®å¾©] å„ªå…ˆæ›´æ–°ä»‹é¢ç‹€æ…‹èˆ‡ç‰¹æ®ŠæŒ‰éˆ• (é€™ä¸ä¾è³´å¾Œç«¯ç©å®¶è³‡æ–™)
            // ç¢ºä¿å³ä½¿æ²’æœ‰ç©å®¶è³‡æ–™ï¼Œè‹¥ activeItem ç‚º null ä¹Ÿèƒ½æ¸…é™¤æ®˜ç•™çš„æŒ‰éˆ•
            app.renderActiveItemStatus();
            app.renderHorusButtons(); 

            // æ¥è‘—æ‰æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™ä¾†æ¸²æŸ“ã€ŒèƒŒåŒ…æ¸…å–®ã€
            if (!app.state.myTeam || !app.state.myName || !players) return;
            
            const myData = players[app.state.myTeam]?.[app.state.myName];
            const items = myData?.items || {};
            const invEl = app.el('student-inventory');
            const listEl = app.el('inventory-list');
            
            const hasItems = (items.hint > 0) || (items.double > 0) || (items.horus > 0) || (items.nile > 0);
            if (!hasItems) {
                invEl.classList.add('hidden');
                return;
            }
            invEl.classList.remove('hidden');

            let html = '';
            // 1. æç¤ºå¡
            if (items.hint > 0) {
                html += `<div onclick="app.useItem('hint')" class="item-slot" title="æç¤ºå¡"><div class="item-icon">ğŸ“œ</div><div class="item-count">${items.hint}</div></div>`;
            }
            
            // 2. ç‹€æ…‹åˆ‡æ›å‹é“å…·
            const renderToggleItem = (type, icon, title) => {
                if (items[type] > 0) {
                    const isActive = app.state.activeItem === type;
                    const activeClass = isActive ? 'item-active' : 'opacity-80 hover:opacity-100';
                    return `<div onclick="app.useItem('${type}')" class="item-slot ${activeClass}" title="${title}"><div class="item-icon">${icon}</div><div class="item-count">${items[type]}</div></div>`;
                }
                return '';
            };

            html += renderToggleItem('double', 'ğŸ¦‚', 'è–ç”²èŸ²ï¼šä¸‹é¡Œåˆ†æ•¸åŠ å€');
            html += renderToggleItem('horus', 'ğŸ‘ï¸', 'è·é­¯æ–¯ä¹‹çœ¼ï¼šå°‡ä¸€é¡†éª°å­è¦–ç‚º 1~3');
            html += renderToggleItem('nile', 'ğŸŒŠ', 'å°¼ç¾…æ²³æ©è³œï¼šåªéœ€å…©é¡†éª°å­');

            listEl.innerHTML = html;
        },

        // v3.3.1 æ›´æ–°ï¼šä½¿ç”¨é“å…· (æ”¯æ´äº’æ–¥åˆ‡æ›èˆ‡ UI æ›´æ–°)
        useItem: (type) => {
            if (app.state.gameData.status !== 'playing') return app.toast('âœ‹ éŠæˆ²å°šæœªé–‹å§‹');

            // é¡å‹ A: ç«‹å³æ¶ˆè€—å‹
            if (type === 'hint') {
                if (!confirm('ğŸ“œ ç¢ºå®šè¦æ¶ˆè€—ä¸€å¼µã€Œæç¤ºå¡ã€ä¾†ç²å¾—é‹ç®—æç¤ºå—ï¼Ÿ')) return;
                const { d8, d10, d12 } = app.state.gameData.dice;
                const solution = app.findSolution([d8, d10, d12]);
                if (solution) {
                    const ref = db.ref(`classes/${app.state.classId}/players/${app.state.myTeam}/${app.state.myName}/items/hint`);
                    ref.transaction(count => (count || 0) - 1);
                    const match = solution.match(/(\(\d+\s*[\+\-\*\/]\s*\d+\)|\d+\s*[\+\-\*\/]\s*\d+)/); 
                    let hint = match ? match[0] : solution;
                    app.speak("æç¤ºå¡å·²ä½¿ç”¨");
                    alert(`ğŸ’¡ æ³•è€ç‹çš„ä½èªï¼šè©¦è©¦çœ‹å…ˆç®— ${hint}`);
                } else {
                    app.toast('âš ï¸ ç•¶å‰ä¼¼ä¹ç„¡è§£');
                }
                return;
            } 
            
            // é¡å‹ B: ç‹€æ…‹åˆ‡æ›å‹
            if (app.state.activeItem === type) {
                app.state.activeItem = null; // å–æ¶ˆ
                app.toast('å·²å–æ¶ˆé“å…·æ•ˆæœ');
            } else {
                app.state.activeItem = type; // å•Ÿå‹•
            }
            
            // é‡æ–°æ¸²æŸ“
            app.renderStudentInventory(app.state.gameData.players);
        },

        // v3.3.1 æ–°å¢ï¼šé¡¯ç¤ºé“å…·ç‹€æ…‹æ¡†
        renderActiveItemStatus: () => {
             const statusEl = app.el('active-item-status');
             const type = app.state.activeItem;
             
             if (!type) {
                 statusEl.classList.add('hidden');
                 return;
             }
             
             const configs = {
                 double: { icon: 'ğŸ¦‚', name: 'è–ç”²èŸ²ç¥ç¦', desc: 'æœ¬é¡Œåˆ†æ•¸ x2 (å†æ¬¡é»æ“Šå¯é—œé–‰)' },
                 horus: { icon: 'ğŸ‘ï¸', name: 'è·é­¯æ–¯ä¹‹çœ¼', desc: 'å¯ä½¿ç”¨ä¸‹æ–¹ 1, 2, 3 æŒ‰éˆ• (å†æ¬¡é»æ“Šå¯é—œé–‰)' },
                 nile: { icon: 'ğŸŒŠ', name: 'å°¼ç¾…æ²³æ©è³œ', desc: 'æœ¬å›åˆåªéœ€ 2 é¡†éª°å­ (å†æ¬¡é»æ“Šå¯é—œé–‰)' }
             };
             
             const cfg = configs[type];
             // ä½¿ç”¨ç„¡ç©ºç™½ innerHTML
             statusEl.innerHTML = `<div class="font-black text-amber-900 text-lg flex items-center justify-center gap-2"><span>${cfg.icon}</span><span>${cfg.name}å•Ÿç”¨ä¸­</span></div><div class="text-sm text-amber-700 font-bold mt-1">${cfg.desc}</div>`;
             statusEl.classList.remove('hidden');
        },

        // v3.3.1 æ–°å¢ï¼šæ¸²æŸ“è·é­¯æ–¯ä¹‹çœ¼æŒ‰éˆ• (1, 2, 3)
        renderHorusButtons: () => {
            const area = app.el('horus-input-area');
            if (app.state.activeItem === 'horus') {
                // ç¶ è‰²åº•è‰²ï¼Œç²—é»‘å­—é«”
                const btnClass = "cursor-control-btn bg-green-400 hover:bg-green-500 text-black border-b-4 border-green-700 active:border-b-0 active:translate-y-1 rounded-lg font-black text-2xl shadow py-2 transition-all";
                area.innerHTML = `<button onclick="app.inputChar('1')" class="${btnClass}">1</button><button onclick="app.inputChar('2')" class="${btnClass}">2</button><button onclick="app.inputChar('3')" class="${btnClass}">3</button>`;
                area.classList.remove('hidden');
            } else {
                area.innerHTML = '';
                area.classList.add('hidden');
            }
        },
        generateInitialGameData: () => {
            const decks = app.createFullDeck();
            const pyramid = new Array(10);
            
            pyramid[0] = decks.black.pop();
            pyramid[1] = decks.red.pop(); pyramid[2] = decks.red.pop();
            pyramid[3] = decks.blue.pop(); pyramid[4] = decks.blue.pop(); pyramid[5] = decks.blue.pop();
            pyramid[6] = decks.yellow.pop(); pyramid[7] = decks.yellow.pop(); pyramid[8] = decks.yellow.pop(); pyramid[9] = decks.yellow.pop();
            
            return { pyramid, decks };
        }
    };

    // å•Ÿå‹•
    window.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>